# Letter to Myself (Session Handoff)

**Date:** 2026-02-10

## 1. Executive Summary
* **Goal:** Extend the usage dashboard with cost analytics (by model, by bot, projected monthly), and add embed snippet tabs to bot profile cards.
* **Current Status:** All features complete and deployed to production. 85 tests passing.

## 2. The "Done" List (Context Anchor)
* Added "Embed" button to bot cards in `dashboard/index.html` with 3 tabs: Script Tag, Custom Element, Styling
* Added `embedBot`, `embedTab`, `embedTabs`, `showEmbed()`, `getEmbedSnippet(tab)`, `copySnippet()` to `botsPage()` in `dashboard/index.html`
* Updated `docs/widget-integration.md` Dashboard Integration section
* Added model pricing map (14 models: OpenAI, Anthropic, Google) in `app/api/v1/stats.py`
* Added `_get_pricing()` and `_calc_cost()` helpers in `app/api/v1/stats.py`
* Added schemas: `BotUsage`, `ModelUsage`, `CostEstimate` in `app/api/v1/stats.py`
* New endpoint `GET /v1/stats/usage/by-bot` — usage grouped by bot_profile_id + model, with cost
* New endpoint `GET /v1/stats/usage/by-model` — usage grouped by model, with cost and rate info
* New endpoint `GET /v1/stats/cost-estimate?days=30` — total cost, daily avg, projected monthly, by_model + by_bot breakdowns
* Added `getUsageByBot()`, `getUsageByModel()`, `getCostEstimate(days)` to `dashboard/js/api.js`
* Redesigned usage page in `dashboard/index.html`: 4 summary stat cards, cost-by-model doughnut chart, 3 tabbed tables (By Model, By Bot, Daily)
* Rewrote `usagePage()` in `dashboard/index.html` with client-side `MODEL_PRICING` map, `formatUsd()`, `calcRowCost()`, parallel API loading
* Added 8 new tests in `tests/test_stats.py`: empty state tests, with-data tests (exact cost math validation), custom days param, auth guards
* Three deploys: `8dbfd61` (embed button), `d35d782` (embed tabs), `92cddc6` (cost analytics)

## 3. The "Pain" Log (CRITICAL)
* **Tried:** Using `data["tenant_id"]` from bootstrap response in test helper
* **Failed:** `KeyError: 'tenant_id'` — the bootstrap response nests tenant info under `data["tenant"]["id"]`
* **Workaround:** Changed to `data["tenant"]["id"]`
* **Tried:** Using `me_resp.json()["id"]` to get user_id from `/v1/auth/me`
* **Failed:** `KeyError: 'id'` — the me response nests user info under `data["user"]["id"]`
* **Workaround:** Changed to `me_resp.json()["user"]["id"]`
* **Tried:** Creating Chat without `user_id` in test helper
* **Failed:** `NOT NULL constraint failed: chats.user_id`
* **Workaround:** Fetched user_id from `/v1/auth/me` endpoint and passed to Chat constructor
* *Note:* Bootstrap response shape: `{ tenant: { id, name, ... }, api_token, token_prefix }`. Me response shape: `{ user: { id, ... }, tenant: { ... } }`.

## 4. Active Variable State
* 85 tests passing (SQLite in-memory, no Docker needed)
* Python command: `.venv/bin/python` (not `python` — not on PATH)
* Docker services: postgres:5432, qdrant:6333, redis:6379
* Production: mini-rag.de — all 3 commits deployed via GitHub Actions
* Branch: `main`, up to date with `origin/main`
* Model pricing: static dict in `app/api/v1/stats.py`, duplicated client-side in `usagePage()` for daily row cost calculation

## 5. Immediate Next Steps
1. [ ] Manual QA on mini-rag.de: verify usage page renders cost cards, charts, and all 3 tabs
2. [ ] Consider adding date range filter (e.g., last 7/30/90 days dropdown) to the usage page UI
3. [ ] Consider moving `MODEL_PRICING` to a shared config or DB table so it can be updated without redeploying
4. [ ] Add Postman requests for the 3 new stats endpoints to `postman/MiniRAG.postman_collection.json`
