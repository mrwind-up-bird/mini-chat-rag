# Letter to Myself (Session Handoff)

**Date:** 2026-02-09

## 1. Executive Summary
* **Goal:** Implement production deployment infrastructure for MiniRAG (Hetzner VPS + Docker Compose + Caddy + CI/CD)
* **Current Status:** All Phase 1 code changes complete and verified — 77 tests passing, compose config validates

## 2. The "Done" List (Context Anchor)
* Created `.dockerignore` — excludes `.git`, `.venv`, `tests/`, `.data/`, `.memory/`, `drafts/`, `__pycache__`, `.env`, etc.
* Created `Caddyfile` — reverse proxy to `web:8000`, `{$DOMAIN}` env var, security headers (HSTS, X-Content-Type-Options, X-Frame-Options)
* Created `docker-compose.prod.yml` — Caddy service (ports 80/443), `!override` to remove dev ports on postgres/qdrant/redis/web, remove dev volume mounts, resource limits (postgres 512M, qdrant 1G, redis 128M, web 512M, worker 512M), json-file log rotation
* Modified `app/core/config.py` — added `allowed_origins: str = "*"` field
* Modified `app/main.py` — CORS middleware now reads `settings.allowed_origins`, splits by comma instead of hardcoded `["*"]`
* Created `.env.production.example` — template with Docker service hostnames, `DOMAIN`, `ALLOWED_ORIGINS`, secret generation instructions
* Created `.github/workflows/deploy.yml` — GitHub Actions: build web+worker images → push to GHCR → SSH deploy via `appleboy/ssh-action`, triggered on push to `main` (filtered by `app/`, `dashboard/`, `Dockerfile`, `docker-compose*.yml`, `Caddyfile`, `pyproject.toml`)
* Created `scripts/setup-vps.sh` — Docker install, UFW (22/80/443), `minirag` user, `/opt/minirag` directory, auto-generates Fernet key + JWT secret + Postgres password into `.env`
* Created `scripts/backup.sh` — `pg_dump` gzip + Qdrant snapshot via REST API, 7-day retention, cron-ready
* Updated `.gitignore` — added `.env.*` with `!.env.production.example` exception

## 3. The "Pain" Log (CRITICAL)
* **Docker Compose `!override`**: The `!override` YAML tag is needed to reset lists (ports, volumes) in override files. Verified it works with `docker compose config`. Without it, lists merge instead of replace.
* **Exposed API keys**: The `.env` file was read during the session and contains real OpenAI + Anthropic API keys. **User must rotate these keys immediately.**
* No major technical issues encountered — all changes were straightforward.

## 4. Active Variable State
* `.env` has `DATABASE_URL` pointing to `localhost` (dev), production template uses Docker hostname `postgres`
* Default `ALLOWED_ORIGINS=*` in config.py — production should set to actual domain
* `DOMAIN` env var in Caddyfile defaults to `:80` (HTTP only) when unset — set to domain name for auto-HTTPS
* Docker services running locally: postgres:5432, qdrant:6333, redis:6379
* 77 tests passing on Python 3.12 with aiosqlite

## 5. Immediate Next Steps
1. [ ] **Rotate API keys** — OpenAI and Anthropic keys exposed in session, must be regenerated
2. [ ] **Phase 2: Server setup** — Create Hetzner CX22 (Ubuntu 24.04), SSH in, run `scripts/setup-vps.sh`
3. [ ] Point domain A record to VPS IP address
4. [ ] Copy `docker-compose.yml`, `docker-compose.prod.yml`, `Caddyfile` to `/opt/minirag/`
5. [ ] Edit `/opt/minirag/.env` with real secrets, domain, LLM API keys
6. [ ] First deploy: `docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d`
7. [ ] **Phase 3: CI/CD** — Add GitHub secrets (`VPS_HOST`, `VPS_SSH_KEY`, `VPS_USER`), push to main to trigger first automated deploy
8. [ ] Add `scripts/backup.sh` to cron: `0 3 * * * /opt/minirag/scripts/backup.sh`
9. [ ] Commit all new files to git
