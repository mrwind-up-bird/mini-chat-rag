# Letter to Myself (Session Handoff)

**Date:** 2026-02-10

## 1. Executive Summary
* **Goal:** Add date range filtering to usage dashboard, Postman stats requests, and fix a cross-DB SQLite/PostgreSQL bug.
* **Current Status:** All features complete, deployed to production, checkpoint pushed. 86 tests passing. Session idle.

## 2. The "Done" List (Context Anchor)
* Added optional `days` query param to `GET /v1/stats/usage`, `/usage/by-bot`, `/usage/by-model` in `app/api/v1/stats.py`
* Fixed cross-DB bug: replaced `cast(UsageEvent.created_at, Date)` with `func.date(UsageEvent.created_at)` in `app/api/v1/stats.py` (both SELECT and cost-estimate active_days count)
* Cleaned up import: `from sqlalchemy import func` (removed unused `cast, Date`)
* Added date range dropdown (7d / 30d / 90d / All time) to usage page header in `dashboard/index.html`
* Added `selectedDays: '30'` state and wired `load()` to pass days to all 4 parallel API calls in `usagePage()`
* Updated `getUsage(days)`, `getUsageByBot(days)`, `getUsageByModel(days)` in `dashboard/js/api.js`
* Added "6 — Stats & Usage" folder (6 requests) to `postman/MiniRAG.postman_collection.json`, renumbered old "6 — Cleanup" to "7 — Cleanup"
* Added `test_days_filter_on_all_endpoints` test in `tests/test_stats.py`
* Committed as `86aefaa`, pushed, deployed to mini-rag.de
* Pushed checkpoint `ab6c345` (`.memory/letter_20260210_0003.md`)

## 3. The "Pain" Log (CRITICAL)
* **Tried:** `cast(UsageEvent.created_at, Date)` in SQLAlchemy SELECT/GROUP BY with SQLite test DB
* **Failed:** `TypeError: fromisoformat: argument must be str` — SQLite's `CAST(x AS DATE)` uses numeric affinity, returning an integer. SQLAlchemy's Date processor then calls `fromisoformat(int)` which fails.
* **Workaround:** Replaced with `func.date(X)` — generates `date(x)` SQL that works in both SQLite (returns `'2026-02-10'` string) and PostgreSQL (returns date object). Both convert cleanly via `str()`.
* *Note:* Bug was pre-existing but masked — no test covered daily usage endpoint with actual data. Now covered by `test_days_filter_on_all_endpoints`.

## 4. Active Variable State
* 86 tests passing (SQLite in-memory, no Docker needed)
* Python command: `.venv/bin/python`
* Docker services: postgres:5432, qdrant:6333, redis:6379
* Production: mini-rag.de — all deployed, up to date with `origin/main`
* Branch: `main` at `ab6c345`
* Postman collection: 7 folders, ~34 requests
* `.memory/` path does NOT trigger deploy workflow — only triggers Vibe Publisher blog workflow

## 5. Immediate Next Steps
1. [ ] Manual QA on mini-rag.de: verify date range dropdown renders and filters data correctly
2. [ ] Run `newman run postman/MiniRAG.postman_collection.json` to validate new Postman requests against live server
3. [ ] Consider moving `MODEL_PRICING` to shared config or DB table (currently duplicated in `app/api/v1/stats.py` and `usagePage()` client-side)
4. [ ] Consider adding date range label to daily chart title (e.g., "Token Usage by Day (Last 30 days)")
5. [ ] Consider rate limiting or caching on stats endpoints if they become slow with large datasets
