# Letter to Myself (Session Handoff)

**Date:** 2026-02-11

## 1. Executive Summary
* **Goal:** Implement F1 — Streaming Chat Responses (SSE) for the MiniRAG platform, covering backend SSE endpoint, orchestrator streaming generator, dashboard Try It panel, embeddable widget, and comprehensive tests.
* **Current Status:** F1 is fully implemented and tested. 95 tests passing, lint clean. Ready to commit and move to the next feature on the roadmap (F2–F7).

## 2. The "Done" List (Context Anchor)
* Added `stream: bool = False` to `ChatRequest` schema in `app/api/v1/chat.py`
* Built `run_chat_turn_stream()` async generator in `app/services/orchestrator.py` — yields `StreamEvent` (sources, delta) then final `ChatResponse`
* Added `StreamEvent` dataclass and TTFT/stream_duration timing to `ChatResponse`
* Built SSE streaming route in `app/api/v1/chat.py` — branches on `body.stream`, returns `StreamingResponse` with `text/event-stream`
* Extracted `_persist_assistant_message()` helper shared by streaming and non-streaming paths
* Added `_format_sse()` helper and `_stream_chat_sse()` async generator with error handling
* Added `is_stream`, `time_to_first_token_ms`, `stream_duration_ms` columns to `UsageEvent` model and `UsageEventRead` schema
* Built `API.sendMessageStream()` in `dashboard/js/api.js` — fetch + ReadableStream SSE parser with callbacks
* Updated `sendTryMessage()` in `dashboard/index.html` — streaming with incremental token rendering
* Rewrote widget `_send()` in `dashboard/widget/minirag-widget.js` — streaming with `_updateStreamingMessage()` for partial DOM updates
* Created `tests/test_chat_streaming.py` with 7 tests: new conversation, continue, persist, usage, regression, empty response, tenant isolation

## 3. The "Pain" Log (CRITICAL)
* **Tried:** Initially had orchestrator yield both a `done` StreamEvent AND a final `ChatResponse` — this caused duplicate `done` events since the route also emits `done` after persistence
* **Fix:** Removed `done` event from orchestrator; route sends it after persistence (so it includes `message_id`)
* **Tried:** `result.data` reference in `_stream_chat_sse` — `ChatResponse` is a dataclass, not a dict, has no `.data` attribute
* **Fix:** Replaced with explicit dict construction from `result.model`, `result.prompt_tokens`, etc.
* **Tried:** Had unused `_retrieve_context()` helper and stale imports (`json`, `MessageRole`) in orchestrator
* **Fix:** Removed dead code, ruff caught the unused imports

## 4. Active Variable State
* 95 tests passing (88 existing + 7 new streaming tests)
* All lint checks clean (ruff)
* SSE event protocol: `sources` → `delta`(s) → `done` (with `chat_id`, `message_id`, `usage`)
* Widget uses `fetch` + `ReadableStream` (not `EventSource`) because we need POST + auth headers
* `stream: false` is the default — zero breaking changes to existing API consumers

## 5. Immediate Next Steps
1. [ ] Commit all F1 changes
2. [ ] Choose next feature from roadmap (F2–F7) using the virtual product team process
3. [ ] F2 (Scheduled Re-Ingestion) and F3 (Webhooks) are the next most impactful features
4. [ ] Consider updating Postman collection with streaming request examples
5. [ ] Consider adding TTFT metrics display to the usage dashboard page
