# Letter to Myself (Session Handoff)

**Date:** 2026-02-09 (evening)

## 1. Executive Summary
* **Goal:** Deploy MiniRAG to production on Hetzner VPS with full infrastructure (Caddy, CI/CD, domain, database seeding)
* **Current Status:** Fully deployed and operational at `https://mini-rag.de` — dashboard accessible, CI/CD working, auto-HTTPS active

## 2. The "Done" List (Context Anchor)
* All production infrastructure files created and deployed (see letter_20260209_0001.md and _0002.md for full list)
* Fixed Qdrant healthcheck: `bash -c '</dev/tcp/localhost/6333'` in `docker-compose.yml` (no curl/wget in image)
* Fixed production `.env`: changed `localhost` → Docker service hostnames (`postgres`, `redis`, `qdrant`)
* Set up domain `mini-rag.de` with Let's Encrypt auto-HTTPS via Caddy
* Removed stale AAAA DNS records causing `*.your-server.de` cert mismatch
* Generated ed25519 deploy key (`~/.ssh/minirag_deploy`), configured GitHub secrets (`VPS_HOST`, `VPS_USER`, `VPS_SSH_KEY`)
* CI/CD pipeline tested and working — `appleboy/ssh-action` → git pull → docker compose up --build (~17s deploys)
* Added root URL redirect to Vercel landing page in `Caddyfile`: `redir / https://landingpage-mini-rag.vercel.app/ permanent`
* Bootstrapped production tenant via `POST /v1/tenants` with correct field names (`tenant_name`, `tenant_slug`, `owner_email`, `owner_password`)
* Dashboard login confirmed working at `https://mini-rag.de/dashboard`

## 3. The "Pain" Log (CRITICAL)
* **Tried:** `curl` then `wget` for Qdrant healthcheck
* **Failed:** Qdrant image has neither — container stays "unhealthy" forever
* **Workaround:** `bash -c '</dev/tcp/localhost/6333'` — bash built-in TCP check
* *Note:* Never use curl/wget in qdrant/qdrant image healthchecks.

* **Tried:** Docker Compose with `.env` using `localhost` hostnames
* **Failed:** `ConnectionRefusedError` — containers can't reach each other via localhost
* **Workaround:** Use Docker service names: `postgres`, `redis`, `qdrant`

* **Tried:** HTTPS from local machine after domain setup
* **Failed:** Stale AAAA records (`2a01:4f8:d0a:27bd::2`) served `*.your-server.de` cert; Chrome DNS cache held stale IP `88.198.219.246`
* **Workaround:** Delete AAAA records, flush Chrome DNS (`chrome://net-internals/#dns` → Clear host cache + flush socket pools), flush macOS DNS (`sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder`)

* **Tried:** Bootstrap tenant with field names `name`, `slug`, `admin_email`, `admin_password`
* **Failed:** 422 — actual fields are `tenant_name`, `tenant_slug`, `owner_email`, `owner_password` (see `app/api/v1/tenants.py:21-24`)
* **Workaround:** Used correct field names

* **Tried:** Postman to create tenant
* **Failed:** Pre-request script randomized the body — response showed `Test Corp test-mlfs75bc` instead of intended data, created junk tenant with slug `minirag`
* **Workaround:** Used curl directly; created new tenant with slug `minirag-prod`

## 4. Active Variable State
* Server: Hetzner CX22 at `46.225.92.50` (`mini-rag.de`)
* SSH: `root@mini-rag.de`, deploy key at `~/.ssh/minirag_deploy`
* Production `.env` at `/opt/minirag/.env` — Docker hostnames, generated secrets, `DOMAIN=mini-rag.de`, `ALLOWED_ORIGINS=https://mini-rag.de`
* GitHub secrets: `VPS_HOST`, `VPS_USER`, `VPS_SSH_KEY` configured
* Production tenant: id `4cc8398e-cd95-45ff-8454-15dc2f7cb6ce`, slug `minirag-prod`, owner `oliver.baer@gmail.com`
* API token prefix: `BtGFUtlE`
* Junk tenant exists: slug `minirag` (from Postman pre-request script) — can be cleaned up
* App version: `0.1.1`
* All 6 containers running: caddy, web, worker, postgres, qdrant, redis

## 5. Immediate Next Steps
1. [ ] Add LLM API keys to `/opt/minirag/.env` on server (`OPENAI_API_KEY`, etc.) for chat to work
2. [ ] Set up backup cron: `crontab -e` → `0 3 * * * /opt/minirag/scripts/backup.sh >> /opt/minirag/backups/backup.log 2>&1`
3. [ ] Rotate local API keys — OpenAI and Anthropic keys in local `.env` were exposed in earlier session
4. [ ] Clean up junk tenant (slug `minirag`) from production database
5. [ ] Add link to dashboard (`https://mini-rag.de/dashboard`) on the Vercel landing page
6. [ ] Consider adding `www.mini-rag.de` redirect in Caddyfile
7. [ ] Set up UptimeRobot or similar for `https://mini-rag.de/health` monitoring
