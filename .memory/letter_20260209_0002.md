# Letter to Myself (Session Handoff)

**Date:** 2026-02-09

## 1. Executive Summary
* **Goal:** Deploy MiniRAG to production on Hetzner VPS with Docker Compose, Caddy auto-HTTPS, and GitHub Actions CI/CD
* **Current Status:** Fully deployed and operational at `https://mini-rag.de` with working CI/CD pipeline

## 2. The "Done" List (Context Anchor)
* Created `.dockerignore`, `Caddyfile`, `docker-compose.prod.yml`, `.env.production.example`, `scripts/setup-vps.sh`, `scripts/backup.sh`
* Created `.github/workflows/deploy.yml` — simplified to git pull + docker compose build on-server (removed GHCR approach)
* Modified `app/core/config.py` — added `allowed_origins: str` setting for configurable CORS
* Modified `app/main.py` — CORS reads from `settings.allowed_origins`, bumped version to `0.1.1`
* Updated `.gitignore` — added `.env.*` with `!.env.production.example` exception
* Fixed Qdrant healthcheck in `docker-compose.yml` — changed from `curl` to `bash -c '</dev/tcp/localhost/6333'` (Qdrant image has neither curl nor wget)
* Fixed production `.env` — changed `localhost` to Docker service hostnames (`postgres`, `redis`, `qdrant`)
* Set up domain `mini-rag.de` with Hetzner DNS, Caddy auto-HTTPS via Let's Encrypt
* Removed stale AAAA records that were pointing to old Hetzner server (`88.198.219.246`)
* Generated ed25519 deploy key (`~/.ssh/minirag_deploy`), added to server + GitHub secrets
* CI/CD pipeline tested and working — deploy job runs in ~9 seconds

## 3. The "Pain" Log (CRITICAL)
* **Tried:** `curl` for Qdrant healthcheck in docker-compose.yml
* **Failed:** Qdrant image (`qdrant/qdrant:v1.13.2`) has no `curl`
* **Tried:** `wget` as fallback
* **Failed:** Qdrant image also has no `wget`
* **Workaround:** `bash -c '</dev/tcp/localhost/6333'` — uses bash built-in TCP check, no external tools needed
* *Note:* Do not use curl or wget in Qdrant healthchecks.

* **Tried:** Building Docker images on server without source code (only compose files + Caddyfile copied)
* **Failed:** `COPY pyproject.toml ./` — file not found in build context
* **Workaround:** Cloned full repo to `/opt/minirag/`, simplified CI/CD to `git pull` + `docker compose up --build` instead of GHCR push/pull

* **Tried:** HTTPS access from local machine after setting up domain
* **Failed:** `SSL: no alternative certificate subject name matches target host name 'mini-rag.de'` — old AAAA records (`2a01:4f8:d0a:27bd::2`) pointed to Hetzner's default server serving `*.your-server.de` cert
* **Workaround:** Deleted AAAA records from Hetzner DNS, flushed Chrome DNS cache (`chrome://net-internals/#dns`), flushed macOS cache (`sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder`)

* **Tried:** `.env` with `localhost` hostnames in Docker Compose
* **Failed:** `ConnectionRefusedError: [Errno 111] Connection refused` — web container can't reach postgres/redis/qdrant via localhost
* **Workaround:** Changed to Docker service hostnames: `postgres:5432`, `redis:6379`, `qdrant:6333`

## 4. Active Variable State
* Server: Hetzner CX22 at `46.225.92.50` (`mini-rag.de`)
* SSH: `root@mini-rag.de`, deploy key at `~/.ssh/minirag_deploy`
* Production `.env` at `/opt/minirag/.env` with Docker service hostnames, generated secrets
* `DOMAIN=mini-rag.de`, `ALLOWED_ORIGINS=https://mini-rag.de`
* GitHub secrets configured: `VPS_HOST`, `VPS_USER`, `VPS_SSH_KEY`
* All 6 containers running: caddy, web, worker, postgres, qdrant, redis
* App version: `0.1.1`

## 5. Immediate Next Steps
1. [ ] Add LLM API keys to `/opt/minirag/.env` on server (OPENAI_API_KEY, etc.) for chat endpoint
2. [ ] Set up backup cron: `crontab -e` → `0 3 * * * /opt/minirag/scripts/backup.sh >> /opt/minirag/backups/backup.log 2>&1`
3. [ ] **Rotate local API keys** — OpenAI and Anthropic keys in local `.env` were exposed in an earlier session
4. [ ] Test dashboard at `https://mini-rag.de/dashboard`
5. [ ] Consider adding `www.mini-rag.de` redirect in Caddyfile
6. [ ] Set up UptimeRobot or similar for `https://mini-rag.de/health` monitoring
