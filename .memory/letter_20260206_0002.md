# Letter to Myself (Session Handoff)

**Date:** 2026-02-06

## 1. Executive Summary
* **Goal:** Building "MiniRAG", a modular, provider-agnostic RAG platform with multi-tenancy — Steps 1 & 2 complete.
* **Current Status:** Step 2 fully done and tested. About to start Step 3 (BotProfile & Source CRUD).

## 2. The "Done" List (Context Anchor)
* **Step 1 (Project Setup):**
  * Created folder structure (`app/api/v1`, `app/core`, `app/models`, `app/services`, `app/workers`)
  * `docker-compose.yml` — Postgres 16, Qdrant 1.13, Redis 7, web, worker (all healthchecked)
  * Multi-stage `Dockerfile` with `web` and `worker` targets
  * `pyproject.toml` with hatchling build + all deps
  * `app/core/config.py` — pydantic-settings with `@lru_cache`
  * `app/core/database.py` — async SQLAlchemy engine, session factory, `init_db()`
  * `app/core/security.py` — Argon2, SHA-256 token hashing, Fernet encryption, JWT
  * `app/models/base.py` — `TimestampMixin`, `utcnow()`, `new_uuid()`
  * `app/models/tenant.py` — `Tenant` + schemas
  * `app/models/user.py` — `User` + `UserRole` StrEnum + schemas
  * `app/models/api_token.py` — `ApiToken` (hash-only storage) + `ApiTokenCreated`
  * `app/main.py` — FastAPI app with lifespan, `/health`
* **Step 2 (Auth & Middleware):**
  * `app/api/deps.py` — `AuthContext`, `get_auth_context` (API token SHA-256 lookup + JWT decode), `Auth`/`Session` typed shortcuts
  * `app/api/v1/tenants.py` — `POST /v1/tenants` (bootstrap: tenant+owner+token), `GET /v1/tenants/me`
  * `app/api/v1/api_tokens.py` — create, list, revoke API tokens (all tenant-scoped)
  * `app/api/v1/__init__.py` — v1_router aggregation
  * `tests/conftest.py` — SQLite in-memory async fixtures
  * `tests/test_auth_flow.py` — 4 passing tests (bootstrap, dup slug 409, bad token 401, missing auth)

## 3. The "Pain" Log (CRITICAL)
* **Tried:** `pip install -e ".[dev]"` without hatch wheel config
* **Failed:** `ValueError: Unable to determine which files to ship inside the wheel`
* **Workaround:** Added `[tool.hatch.build.targets.wheel] packages = ["app"]` to `pyproject.toml`
* *Note:* Always include this hatch config when project name differs from package dir.

* **Tried:** Test expected `403` for missing Authorization header
* **Failed:** Modern FastAPI HTTPBearer returns `401`, not `403`
* **Workaround:** Changed assertion to `assert resp.status_code in (401, 403)`

* **Tried:** Running async SQLAlchemy with aiosqlite without greenlet
* **Failed:** `ValueError: the greenlet library is required`
* **Workaround:** Added `greenlet>=3` and `aiosqlite>=0.20` to dev dependencies

## 4. Active Variable State
* Python venv at `.venv/` (Python 3.12 on this machine)
* No `.env` file yet — only `.env.example` exists
* Docker services not started — tests use SQLite in-memory
* All 4 tests passing: `pytest tests/test_auth_flow.py -v`

## 5. Immediate Next Steps
1. [ ] Step 3: Create `BotProfile` SQLModel (`app/models/bot_profile.py`) with encrypted `credentials` field
2. [ ] Step 3: Create `Source` SQLModel (`app/models/source.py`) with `tenant_id` + `bot_profile_id` FK
3. [ ] Step 3: CRUD endpoints for BotProfile (`app/api/v1/bot_profiles.py`)
4. [ ] Step 3: CRUD endpoints for Source (`app/api/v1/sources.py`)
5. [ ] Step 3: Ensure all queries auto-filter by `tenant_id`
6. [ ] Step 3: Write integration tests for CRUD operations
