# Letter to Myself (Session Handoff)

**Date:** 2026-02-10

## 1. Executive Summary
* **Goal:** Add date range filtering to the usage dashboard and Postman requests for stats endpoints.
* **Current Status:** All features complete and deployed to production. 86 tests passing.

## 2. The "Done" List (Context Anchor)
* Added optional `days` query param to `GET /v1/stats/usage`, `/usage/by-bot`, `/usage/by-model` in `app/api/v1/stats.py`
* Fixed cross-DB bug: replaced `cast(UsageEvent.created_at, Date)` with `func.date(UsageEvent.created_at)` — the `cast(Date)` approach broke in SQLite (returned numeric affinity → `fromisoformat: argument must be str`)
* Removed unused `cast, Date` import from `app/api/v1/stats.py`, now just `from sqlalchemy import func`
* Added date range dropdown (7d / 30d / 90d / All time) to usage page header in `dashboard/index.html`
* Added `selectedDays: '30'` state to `usagePage()` in `dashboard/index.html`
* Updated `load()` in `usagePage()` to pass `selectedDays` to all 4 API calls
* Updated `getUsage(days)`, `getUsageByBot(days)`, `getUsageByModel(days)` in `dashboard/js/api.js` to accept optional `days` param
* Added "6 — Stats & Usage" folder to `postman/MiniRAG.postman_collection.json` with 6 requests: Overview Stats, Daily Usage, Usage by Model, Usage by Bot, Cost Estimate (30d), Cost Estimate (7d)
* Renumbered old "6 — Cleanup" to "7 — Cleanup" in Postman collection
* Added `test_days_filter_on_all_endpoints` test in `tests/test_stats.py`
* Deployed as commit `86aefaa`

## 3. The "Pain" Log (CRITICAL)
* **Tried:** Using `cast(UsageEvent.created_at, Date)` in SQLAlchemy SELECT/GROUP BY with SQLite test DB
* **Failed:** `TypeError: fromisoformat: argument must be str` — SQLite's `CAST(x AS DATE)` uses numeric affinity, returning an integer instead of a date string. SQLAlchemy's Date result processor then tries `fromisoformat(int)` which fails.
* **Workaround:** Replaced all `cast(X, Date)` with `func.date(X)` which generates `date(x)` SQL — works in both SQLite (returns string like `'2026-02-10'`) and PostgreSQL (returns date object). Both convert cleanly with `str()`.
* *Note:* This bug was pre-existing but masked because no test exercised the daily usage endpoint WITH data (only empty-state test existed). The new `test_days_filter_on_all_endpoints` test now covers this case.

## 4. Active Variable State
* 86 tests passing (SQLite in-memory, no Docker needed)
* Python command: `.venv/bin/python` (not `python` — not on PATH)
* Docker services: postgres:5432, qdrant:6333, redis:6379
* Production: mini-rag.de — deployed via GitHub Actions on push to main
* Branch: `main`, up to date with `origin/main`
* Postman collection now has 7 folders, ~34 requests

## 5. Immediate Next Steps
1. [ ] Manual QA on mini-rag.de: verify date range dropdown renders and filters data correctly
2. [ ] Run `newman run postman/MiniRAG.postman_collection.json` to validate new Postman requests against live server
3. [ ] Consider moving `MODEL_PRICING` to a shared config or DB table so pricing can be updated without redeploying (currently duplicated in `app/api/v1/stats.py` backend and `usagePage()` client-side)
4. [ ] Consider adding date range to the daily chart title (e.g., "Token Usage by Day (Last 30 days)")
