# Letter to Myself (Session Handoff)

**Date:** 2026-02-06

## 1. Executive Summary
* **Goal:** Building "MiniRAG", a modular, provider-agnostic RAG platform with multi-tenancy — Steps 1–3 complete.
* **Current Status:** Step 3 fully done and tested (15 passing tests). About to start Step 4 (Ingestion pipeline / ARQ worker).

## 2. The "Done" List (Context Anchor)
* **Step 1 (Project Setup):**
  * Folder structure, `docker-compose.yml` (Postgres 16, Qdrant 1.13, Redis 7, web, worker)
  * Multi-stage `Dockerfile`, `pyproject.toml` with hatchling
  * `app/core/config.py`, `app/core/database.py`, `app/core/security.py`
  * Models: `Tenant`, `User`, `ApiToken` in `app/models/`
  * `app/main.py` with lifespan + `/health`
* **Step 2 (Auth & Middleware):**
  * `app/api/deps.py` — `AuthContext`, dual dispatch (API token SHA-256 / JWT), `Auth`/`Session` shortcuts
  * `app/api/v1/tenants.py` — bootstrap (POST /v1/tenants) + GET /v1/tenants/me
  * `app/api/v1/api_tokens.py` — create, list, revoke
  * `tests/test_auth_flow.py` — 4 passing tests
* **Step 3 (Core API):**
  * `app/models/bot_profile.py` — BotProfile with Fernet-encrypted credentials, `has_credentials` bool in read schema
  * `app/models/source.py` — Source with SourceType/SourceStatus enums, JSON config as Text column
  * `app/api/v1/bot_profiles.py` — full CRUD (POST, GET list, GET detail, PATCH, DELETE soft)
  * `app/api/v1/sources.py` — full CRUD + `?bot_profile_id=` filter + cross-tenant FK validation (422)
  * `tests/test_bot_profiles.py` — 5 tests (CRUD + tenant isolation)
  * `tests/test_sources.py` — 6 tests (CRUD + cross-tenant check + tenant isolation)
  * Fixed deprecation: use `HTTP_422_UNPROCESSABLE_CONTENT` not `_ENTITY`

## 3. The "Pain" Log (CRITICAL)
* **Tried:** `pip install -e ".[dev]"` without hatch wheel config
* **Failed:** `ValueError: Unable to determine which files to ship inside the wheel`
* **Workaround:** Added `[tool.hatch.build.targets.wheel] packages = ["app"]` to `pyproject.toml`

* **Tried:** Test expected `403` for missing Authorization header
* **Failed:** Modern FastAPI HTTPBearer returns `401`, not `403`
* **Workaround:** Changed assertion to `assert resp.status_code in (401, 403)`

* **Tried:** Running async SQLAlchemy with aiosqlite without greenlet
* **Failed:** `ValueError: the greenlet library is required`
* **Workaround:** Added `greenlet>=3` and `aiosqlite>=0.20` to dev dependencies

## 4. Active Variable State
* Python venv at `.venv/` (Python 3.12)
* No `.env` file — only `.env.example`
* Docker services not started — tests use SQLite in-memory
* 15 tests all passing: `pytest tests/ -v`
* `app/workers/main.py` exists as placeholder (empty WorkerSettings)

## 5. Immediate Next Steps
1. [ ] Step 4: Create `Document` and `Chunk` SQLModels (`app/models/document.py`, `app/models/chunk.py`)
2. [ ] Step 4: Implement text normalizer + chunking logic (`app/services/chunking.py`)
3. [ ] Step 4: Implement embedding service using LiteLLM (`app/services/embedding.py`)
4. [ ] Step 4: Implement Qdrant upsert logic (`app/services/vector_store.py`)
5. [ ] Step 4: Wire it all into an ARQ worker task (`app/workers/ingest.py`)
6. [ ] Step 4: Add API endpoint to trigger ingestion for a Source
7. [ ] Step 4: Write tests for the ingestion pipeline
