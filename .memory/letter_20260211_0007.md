# Letter to Myself (Session Handoff)

**Date:** 2026-02-11 ~02:35 UTC

## 1. Executive Summary
* **Goal:** Implement F2 — Scheduled Source Re-Ingestion (Auto-Refresh) for the MiniRAG platform
* **Current Status:** Feature complete, all 108 tests passing, pushed to `main`, deployed to VPS successfully (commit `4b0c636`)

## 2. The "Done" List (Context Anchor)
* Added `RefreshSchedule` enum (none/hourly/daily/weekly) and `refresh_schedule` + `last_refreshed_at` fields to `Source` model in `app/models/source.py`
* Updated `SourceCreate`, `SourceUpdate`, `SourceRead` schemas with refresh fields
* Updated `_to_read()` helper in `app/api/v1/sources.py` to include refresh fields; `create_source` passes `refresh_schedule` through
* Created `app/services/html_extract.py` — stdlib `HTMLParser`-based HTML-to-text (strips script/style, normalizes whitespace, no new deps)
* Made `_extract_content()` in `app/workers/ingest.py` async; added URL source extraction via `httpx.AsyncClient` + `html_to_text()`
* Set `source.last_refreshed_at = utcnow()` after every successful ingest in `app/workers/ingest.py`
* Created `app/workers/refresh.py` — `check_refresh_schedules()` queries eligible sources (active, not processing, schedule != none, past interval) and enqueues ingest jobs via `ctx["redis"]`
* Registered cron job in `app/workers/main.py`: runs at :00, :15, :30, :45 every hour
* Updated `dashboard/index.html`: schedule picker (URL type only) in create modal, "Schedule" and "Last Refresh" columns in sources table
* Created `tests/test_url_ingest.py` (6 tests: html_to_text, URL extraction, fetch error, e2e pipeline)
* Created `tests/test_refresh.py` (7 tests: hourly eligible/not-due, daily eligible, first refresh, processing skipped, inactive skipped, last_refreshed_at updated)
* Updated `tests/test_ingest.py` with `last_refreshed_at is not None` assertion

## 3. The "Pain" Log (CRITICAL)
* **Tried:** Having `app/workers/refresh.py` import `_redis_settings` from `app/workers/main.py`
* **Failed:** Circular import — `main.py` imports `check_refresh_schedules` from `refresh.py`, `refresh.py` imports `_redis_settings` from `main.py`
* **Workaround:** Used ARQ's built-in `ctx["redis"]` pool (available in cron job context) instead of creating a new pool. Tests inject mock pool via `{"redis": mock_pool}`. *Note:* Do not reintroduce `_redis_settings` import in `refresh.py`.

* **Tried:** Initial ruff format with imports in `html_extract.py` as `import re` then `from html.parser import HTMLParser`
* **Failed:** ruff I001 flagged import block as unsorted (wanted `import re` before `from` imports, but they were already in that order — the blank line between them caused the issue)
* **Workaround:** Removed blank line between stdlib imports; `ruff format` handled the rest.

## 4. Active Variable State
* Python 3.12, venv at `.venv/`
* Docker services: postgres:5432, qdrant:6333, redis:6379
* VPS deployment: `/opt/minirag`, auto-deploys on push to `main` via `.github/workflows/deploy.yml`
* Branch: `main`, HEAD at `4b0c636`
* All 108 tests green, no new lint issues (one pre-existing B905 `zip()` warning in `ingest.py`)

## 5. Immediate Next Steps
1. [ ] Run `newman run postman/MiniRAG.postman_collection.json` to verify Postman collection still passes with new schema fields
2. [ ] Manual test: create a URL source with `refresh_schedule=hourly` via dashboard, trigger ingest, verify `last_refreshed_at` shows in table
3. [ ] Add Alembic migration for the two new columns (`refresh_schedule`, `last_refreshed_at`) for production PostgreSQL
4. [ ] Consider F3 (webhook notifications on refresh success/failure) as the next feature
5. [ ] Optional v2 enhancements: diff-based ingestion (skip if content unchanged), per-source custom cron expressions
