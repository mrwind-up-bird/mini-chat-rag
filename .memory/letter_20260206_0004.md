# Letter to Myself (Session Handoff)

**Date:** 2026-02-06

## 1. Executive Summary
* **Goal:** Building "MiniRAG", a modular, provider-agnostic RAG platform with multi-tenancy — Steps 1–4 complete (26 tests passing).
* **Current Status:** Step 4 fully done. About to start Step 5 (Chat endpoint / orchestrator).

## 2. The "Done" List (Context Anchor)
* **Step 1**: Project setup, Docker Compose (Postgres/Qdrant/Redis/web/worker), Dockerfile, pyproject.toml, base models (Tenant, User, ApiToken), core modules (config, database, security)
* **Step 2**: Auth deps (`app/api/deps.py` — AuthContext, dual token dispatch), tenant bootstrap (`POST /v1/tenants`), API token CRUD, 4 tests
* **Step 3**: BotProfile model with Fernet-encrypted credentials, Source model with SourceType/SourceStatus enums, full CRUD endpoints for both, cross-tenant FK validation, 11 tests
* **Step 4**:
  * `app/models/document.py` — Document table (raw content from source)
  * `app/models/chunk.py` — Chunk table (indexed segment + qdrant_point_id)
  * `app/services/chunking.py` — `normalize_text()` + recursive `chunk_text()` splitter (512/64 defaults)
  * `app/services/embedding.py` — LiteLLM `aembedding` wrapper with batching (max 128)
  * `app/services/vector_store.py` — Qdrant client: ensure_collection, upsert, search, delete. Single collection `minirag_chunks` with tenant payload filtering
  * `app/workers/ingest.py` — `ingest_source` ARQ task: content→chunk→embed→upsert→status update
  * `app/workers/main.py` — ARQ WorkerSettings with Redis config parsing
  * `POST /v1/sources/{id}/ingest` trigger endpoint (202 Accepted)
  * `tests/test_chunking.py` — 8 unit tests
  * `tests/test_ingest.py` — 3 integration tests (mocked embed/Qdrant)

## 3. The "Pain" Log (CRITICAL)
* **Tried:** Ingest tests using production `async_session_factory` (points to Postgres)
* **Failed:** `socket.gaierror: [Errno 8] nodename nor servname provided, or not known` — no Postgres running locally
* **Workaround:** Created `test_session_factory` fixture in conftest, patch `app.workers.ingest.async_session_factory` in tests
* *Note:* Always patch the session factory at the module level when testing worker tasks.

* **Tried:** `normalize_text()` without stripping spaces around newlines
* **Failed:** Test expected `"Hello world\n\nfoo"` but got `"Hello world \n\n foo"`
* **Workaround:** Added `re.sub(r" *\n *", "\n", text)` after collapsing spaces

## 4. Active Variable State
* Python venv at `.venv/` (Python 3.12)
* No `.env` file — only `.env.example`
* Docker services not started — tests use SQLite in-memory
* 26 tests all passing: `pytest tests/ -v`
* `conftest.py` exposes `test_session_factory` (session-scoped) for worker tests

## 5. Immediate Next Steps
1. [ ] Step 5: Create `Chat` and `Message` SQLModels (`app/models/chat.py`, `app/models/message.py`)
2. [ ] Step 5: Create `UsageEvent` model for token tracking (`app/models/usage_event.py`)
3. [ ] Step 5: Implement orchestrator service (`app/services/orchestrator.py`) — query rewrite → retrieval → context assembly → LLM generation
4. [ ] Step 5: Create `POST /v1/chat` endpoint with streaming SSE response
5. [ ] Step 5: Capture usage metrics (token counts) in UsageEvent table
6. [ ] Step 5: Write tests for chat flow (mocked LLM + Qdrant)
