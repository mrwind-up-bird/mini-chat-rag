{
  "info": {
    "name": "MiniRAG API",
    "description": "Full test collection for the MiniRAG RAG platform API.\n\n## Setup\n1. Run the collection in order — the Bootstrap request auto-saves the token and IDs.\n2. All subsequent requests use the saved `api_token` variable automatically.\n3. Each run generates a unique tenant slug, so the collection is re-runnable.\n\n## Variables\n- `base_url` — API base (default: http://localhost:8000)\n- `api_token` — Bearer token (auto-set by Bootstrap)\n- `tenant_slug` — Unique per run (auto-generated)\n- `tenant_id`, `profile_id`, `source_id`, `chat_id`, `token_id` — auto-set by test scripts",
    "_postman_id": "minirag-collection-v1",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{api_token}}",
        "type": "string"
      }
    ]
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Generate a unique tenant slug once per collection run",
          "if (!pm.collectionVariables.get('tenant_slug') || pm.collectionVariables.get('tenant_slug') === '') {",
          "    var slug = 'test-' + Date.now().toString(36);",
          "    pm.collectionVariables.set('tenant_slug', slug);",
          "    console.log('Generated tenant_slug: ' + slug);",
          "}"
        ]
      }
    }
  ],
  "variable": [
    { "key": "base_url",     "value": "http://localhost:8000", "type": "string" },
    { "key": "api_token",    "value": "", "type": "string" },
    { "key": "tenant_id",    "value": "", "type": "string" },
    { "key": "tenant_slug",  "value": "", "type": "string" },
    { "key": "profile_id",   "value": "", "type": "string" },
    { "key": "source_id",    "value": "", "type": "string" },
    { "key": "chat_id",      "value": "", "type": "string" },
    { "key": "token_id",     "value": "", "type": "string" }
  ],
  "item": [
    {
      "name": "0 — Health",
      "description": "Quick smoke test — no auth needed.",
      "item": [
        {
          "name": "Health Check",
          "request": {
            "auth": { "type": "noauth" },
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/health", "host": ["{{base_url}}"], "path": ["health"] },
            "description": "Verify the API is running. No authentication required."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Body contains status ok', function () {",
                  "    pm.expect(pm.response.json().status).to.eql('ok');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "1 — Tenant Bootstrap",
      "description": "Tenant lifecycle: create, verify, and error cases.",
      "item": [
        {
          "name": "Bootstrap Tenant",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var slug = pm.collectionVariables.get('tenant_slug');",
                  "var body = {",
                  "    tenant_name: 'Test Corp ' + slug,",
                  "    tenant_slug: slug,",
                  "    owner_email: slug + '@test.com',",
                  "    owner_password: 'supersecret123',",
                  "    owner_display_name: 'Admin User'",
                  "};",
                  "pm.request.body.raw = JSON.stringify(body);"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response has tenant and api_token', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json).to.have.property('tenant');",
                  "    pm.expect(json).to.have.property('api_token');",
                  "    pm.expect(json.tenant).to.have.property('id');",
                  "    pm.expect(json.tenant).to.have.property('slug');",
                  "    pm.expect(json.api_token).to.be.a('string').and.not.empty;",
                  "});",
                  "",
                  "pm.test('Tenant fields are correct', function () {",
                  "    var json = pm.response.json();",
                  "    var slug = pm.collectionVariables.get('tenant_slug');",
                  "    pm.expect(json.tenant.slug).to.eql(slug);",
                  "    pm.expect(json.tenant.is_active).to.be.true;",
                  "    pm.expect(json.tenant.plan).to.eql('free');",
                  "});",
                  "",
                  "// Auto-save variables for subsequent requests",
                  "var json = pm.response.json();",
                  "pm.collectionVariables.set('api_token', json.api_token);",
                  "pm.collectionVariables.set('tenant_id', json.tenant.id);",
                  "console.log('Saved api_token and tenant_id');"
                ]
              }
            }
          ],
          "request": {
            "auth": { "type": "noauth" },
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{}" },
            "url": { "raw": "{{base_url}}/v1/tenants", "host": ["{{base_url}}"], "path": ["v1", "tenants"] },
            "description": "Creates a new tenant with a unique slug. The pre-request script builds the body dynamically.\n\nThe `api_token` in the response is shown **once** — test script auto-saves it."
          }
        },
        {
          "name": "Bootstrap Tenant — Duplicate Slug (409)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "var slug = pm.collectionVariables.get('tenant_slug');",
                  "var body = {",
                  "    tenant_name: 'Duplicate Corp',",
                  "    tenant_slug: slug,",
                  "    owner_email: 'dupe-' + slug + '@test.com',",
                  "    owner_password: 'supersecret123'",
                  "};",
                  "pm.request.body.raw = JSON.stringify(body);"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 409 Conflict', function () {",
                  "    pm.response.to.have.status(409);",
                  "});",
                  "pm.test('Error detail mentions slug', function () {",
                  "    pm.expect(pm.response.json().detail.toLowerCase()).to.include('slug');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": { "type": "noauth" },
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{}" },
            "url": { "raw": "{{base_url}}/v1/tenants", "host": ["{{base_url}}"], "path": ["v1", "tenants"] },
            "description": "Attempting to create a tenant with an existing slug should return 409 Conflict."
          }
        },
        {
          "name": "Get Current Tenant",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Returns correct tenant', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.id).to.eql(pm.collectionVariables.get('tenant_id'));",
                  "    pm.expect(json.slug).to.eql(pm.collectionVariables.get('tenant_slug'));",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/tenants/me", "host": ["{{base_url}}"], "path": ["v1", "tenants", "me"] },
            "description": "Returns the tenant associated with the current bearer token."
          }
        },
        {
          "name": "Unauthenticated Request (401)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 401 or 403', function () {",
                  "    pm.expect([401, 403]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": { "type": "noauth" },
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/tenants/me", "host": ["{{base_url}}"], "path": ["v1", "tenants", "me"] },
            "description": "Requesting an authenticated endpoint without a bearer token should return 401 or 403."
          }
        }
      ]
    },
    {
      "name": "2 — API Tokens",
      "description": "API token lifecycle: create, list, and revoke.",
      "item": [
        {
          "name": "Create API Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "pm.test('Response contains raw_token (shown once)', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json).to.have.property('raw_token');",
                  "    pm.expect(json.raw_token).to.be.a('string').and.not.empty;",
                  "    pm.expect(json.name).to.eql('CI/CD Token');",
                  "    pm.expect(json).to.have.property('token_prefix');",
                  "});",
                  "pm.collectionVariables.set('token_id', pm.response.json().id);",
                  "console.log('Saved token_id: ' + pm.response.json().id);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"name\": \"CI/CD Token\"\n}" },
            "url": { "raw": "{{base_url}}/v1/api-tokens", "host": ["{{base_url}}"], "path": ["v1", "api-tokens"] },
            "description": "Create an additional API token. The `raw_token` is returned only once."
          }
        },
        {
          "name": "List API Tokens",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Returns an array with at least 2 tokens', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json).to.be.an('array');",
                  "    pm.expect(json.length).to.be.at.least(2);",
                  "});",
                  "pm.test('Tokens do NOT expose raw_token', function () {",
                  "    pm.response.json().forEach(function(token) {",
                  "        pm.expect(token).to.not.have.property('raw_token');",
                  "        pm.expect(token).to.have.property('token_prefix');",
                  "    });",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/api-tokens", "host": ["{{base_url}}"], "path": ["v1", "api-tokens"] },
            "description": "List all active API tokens for the current tenant."
          }
        },
        {
          "name": "Revoke API Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 204 No Content', function () {",
                  "    pm.response.to.have.status(204);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/api-tokens/{{token_id}}", "host": ["{{base_url}}"], "path": ["v1", "api-tokens", "{{token_id}}"] },
            "description": "Soft-delete (revoke) an API token."
          }
        }
      ]
    },
    {
      "name": "3 — Bot Profiles",
      "description": "Bot profile CRUD: create, list, get, update, and error cases.",
      "item": [
        {
          "name": "Create Bot Profile",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "pm.test('Bot profile fields are correct', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.name).to.eql('Support Bot');",
                  "    pm.expect(json.model).to.eql('gpt-4o-mini');",
                  "    pm.expect(json.temperature).to.eql(0.7);",
                  "    pm.expect(json.max_tokens).to.eql(1024);",
                  "    pm.expect(json.has_credentials).to.be.false;",
                  "    pm.expect(json.is_active).to.be.true;",
                  "});",
                  "pm.collectionVariables.set('profile_id', pm.response.json().id);",
                  "console.log('Saved profile_id: ' + pm.response.json().id);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"name\": \"Support Bot\",\n  \"description\": \"Handles customer support questions\",\n  \"system_prompt\": \"You are a helpful customer support assistant. Answer questions based on the provided context.\",\n  \"model\": \"gpt-4o-mini\",\n  \"temperature\": 0.7,\n  \"max_tokens\": 1024\n}" },
            "url": { "raw": "{{base_url}}/v1/bot-profiles", "host": ["{{base_url}}"], "path": ["v1", "bot-profiles"] },
            "description": "Create a new bot profile (AI assistant configuration)."
          }
        },
        {
          "name": "Create Bot Profile with Credentials",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "pm.test('Credentials are encrypted — only has_credentials flag returned', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.has_credentials).to.be.true;",
                  "    pm.expect(json).to.not.have.property('credentials');",
                  "    pm.expect(json).to.not.have.property('encrypted_credentials');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"name\": \"Premium Bot\",\n  \"description\": \"Uses custom API key\",\n  \"model\": \"gpt-4o\",\n  \"credentials\": {\n    \"api_key\": \"sk-test-key-12345\"\n  }\n}" },
            "url": { "raw": "{{base_url}}/v1/bot-profiles", "host": ["{{base_url}}"], "path": ["v1", "bot-profiles"] },
            "description": "Create a bot with custom provider credentials. Credentials are encrypted at rest with Fernet."
          }
        },
        {
          "name": "List Bot Profiles",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Returns array of bot profiles', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json).to.be.an('array');",
                  "    pm.expect(json.length).to.be.at.least(1);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/bot-profiles", "host": ["{{base_url}}"], "path": ["v1", "bot-profiles"] },
            "description": "List all active bot profiles for the current tenant."
          }
        },
        {
          "name": "Get Bot Profile",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Returns the correct bot profile', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.id).to.eql(pm.collectionVariables.get('profile_id'));",
                  "    pm.expect(json.name).to.eql('Support Bot');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/bot-profiles/{{profile_id}}", "host": ["{{base_url}}"], "path": ["v1", "bot-profiles", "{{profile_id}}"] },
            "description": "Get a specific bot profile by ID."
          }
        },
        {
          "name": "Update Bot Profile",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Fields were updated', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.description).to.eql('Updated description for Support Bot');",
                  "    pm.expect(json.temperature).to.eql(0.5);",
                  "    pm.expect(json.name).to.eql('Support Bot');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"description\": \"Updated description for Support Bot\",\n  \"temperature\": 0.5\n}" },
            "url": { "raw": "{{base_url}}/v1/bot-profiles/{{profile_id}}", "host": ["{{base_url}}"], "path": ["v1", "bot-profiles", "{{profile_id}}"] },
            "description": "Partially update a bot profile."
          }
        },
        {
          "name": "Get Nonexistent Bot Profile (404)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 404', function () {",
                  "    pm.response.to.have.status(404);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/bot-profiles/00000000-0000-0000-0000-000000000000", "host": ["{{base_url}}"], "path": ["v1", "bot-profiles", "00000000-0000-0000-0000-000000000000"] },
            "description": "Requesting a non-existent bot profile should return 404."
          }
        }
      ]
    },
    {
      "name": "4 — Sources",
      "description": "Source lifecycle: create, list, filter, update, ingest trigger, and error cases.",
      "item": [
        {
          "name": "Create Source (text)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "pm.test('Source fields are correct', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.name).to.eql('Product FAQ');",
                  "    pm.expect(json.source_type).to.eql('text');",
                  "    pm.expect(json.status).to.eql('pending');",
                  "    pm.expect(json.bot_profile_id).to.eql(pm.collectionVariables.get('profile_id'));",
                  "    pm.expect(json.is_active).to.be.true;",
                  "});",
                  "pm.collectionVariables.set('source_id', pm.response.json().id);",
                  "console.log('Saved source_id: ' + pm.response.json().id);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"bot_profile_id\": \"{{profile_id}}\",\n  \"name\": \"Product FAQ\",\n  \"description\": \"Frequently asked questions\",\n  \"source_type\": \"text\",\n  \"content\": \"Q: What is MiniRAG?\\nA: MiniRAG is a modular RAG platform with multi-tenancy.\\n\\nQ: What LLM providers does it support?\\nA: OpenAI, Anthropic, Google Gemini via LiteLLM.\\n\\nQ: How does multi-tenancy work?\\nA: Every table has tenant_id. All queries scoped automatically.\\n\\nQ: What vector DB?\\nA: Qdrant for vector storage and similarity search.\\n\\nQ: Is it authenticated?\\nA: Yes. All endpoints require a Bearer token.\"\n}" },
            "url": { "raw": "{{base_url}}/v1/sources", "host": ["{{base_url}}"], "path": ["v1", "sources"] },
            "description": "Create a text knowledge source linked to a bot profile."
          }
        },
        {
          "name": "List Sources",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Returns array with at least 1 source', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json).to.be.an('array');",
                  "    pm.expect(json.length).to.be.at.least(1);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/sources", "host": ["{{base_url}}"], "path": ["v1", "sources"] },
            "description": "List all sources for the current tenant."
          }
        },
        {
          "name": "List Sources — Filter by Bot Profile",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('All sources belong to the bot profile', function () {",
                  "    var profileId = pm.collectionVariables.get('profile_id');",
                  "    pm.response.json().forEach(function(s) {",
                  "        pm.expect(s.bot_profile_id).to.eql(profileId);",
                  "    });",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/sources?bot_profile_id={{profile_id}}", "host": ["{{base_url}}"], "path": ["v1", "sources"], "query": [{ "key": "bot_profile_id", "value": "{{profile_id}}" }] },
            "description": "List sources filtered by a specific bot profile."
          }
        },
        {
          "name": "Get Source",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Returns the correct source', function () {",
                  "    pm.expect(pm.response.json().id).to.eql(pm.collectionVariables.get('source_id'));",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/sources/{{source_id}}", "host": ["{{base_url}}"], "path": ["v1", "sources", "{{source_id}}"] },
            "description": "Get a specific source by ID."
          }
        },
        {
          "name": "Update Source",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Description was updated', function () {",
                  "    pm.expect(pm.response.json().description).to.eql('Updated FAQ');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"description\": \"Updated FAQ\"\n}" },
            "url": { "raw": "{{base_url}}/v1/sources/{{source_id}}", "host": ["{{base_url}}"], "path": ["v1", "sources", "{{source_id}}"] },
            "description": "Partially update a source."
          }
        },
        {
          "name": "Trigger Ingestion",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 202 Accepted', function () {",
                  "    pm.response.to.have.status(202);",
                  "});",
                  "pm.test('Response confirms ingestion queued', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json).to.have.property('status');",
                  "    pm.expect(json).to.have.property('message');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/sources/{{source_id}}/ingest", "host": ["{{base_url}}"], "path": ["v1", "sources", "{{source_id}}", "ingest"] },
            "description": "Enqueue a background ingestion job. Requires ARQ worker + Redis."
          }
        },
        {
          "name": "Check Source Status After Ingest",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Source status is valid', function () {",
                  "    pm.expect(['pending', 'processing', 'ready', 'error']).to.include(pm.response.json().status);",
                  "});",
                  "console.log('Source status: ' + pm.response.json().status + ', chunks: ' + pm.response.json().chunk_count);"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/sources/{{source_id}}", "host": ["{{base_url}}"], "path": ["v1", "sources", "{{source_id}}"] },
            "description": "Poll the source to check ingestion status."
          }
        },
        {
          "name": "Create Source — Cross-Tenant Bot Profile (422)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 422', function () {",
                  "    pm.response.to.have.status(422);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"bot_profile_id\": \"00000000-0000-0000-0000-000000000000\",\n  \"name\": \"Bad Source\",\n  \"source_type\": \"text\",\n  \"content\": \"test\"\n}" },
            "url": { "raw": "{{base_url}}/v1/sources", "host": ["{{base_url}}"], "path": ["v1", "sources"] },
            "description": "Creating a source with a nonexistent bot_profile_id should return 422."
          }
        }
      ]
    },
    {
      "name": "5 — Chat (RAG)",
      "description": "Chat endpoint: new conversation, follow-up, history, and error cases.\n\nRequires: ingested source + configured LLM provider.",
      "item": [
        {
          "name": "Start New Conversation",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Response has correct structure', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json).to.have.property('chat_id');",
                  "    pm.expect(json).to.have.property('message');",
                  "    pm.expect(json).to.have.property('sources');",
                  "    pm.expect(json).to.have.property('usage');",
                  "});",
                  "pm.test('Message is from assistant', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.message.role).to.eql('assistant');",
                  "    pm.expect(json.message.content).to.be.a('string').and.not.empty;",
                  "});",
                  "pm.test('Usage contains token counts', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.usage).to.have.property('model');",
                  "    pm.expect(json.usage).to.have.property('total_tokens');",
                  "});",
                  "pm.collectionVariables.set('chat_id', pm.response.json().chat_id);",
                  "console.log('Saved chat_id: ' + pm.response.json().chat_id);"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"bot_profile_id\": \"{{profile_id}}\",\n  \"message\": \"What is MiniRAG and what LLM providers does it support?\"\n}" },
            "url": { "raw": "{{base_url}}/v1/chat", "host": ["{{base_url}}"], "path": ["v1", "chat"] },
            "description": "Send a message without chat_id to start a new conversation."
          }
        },
        {
          "name": "Continue Conversation",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Uses the same chat_id', function () {",
                  "    pm.expect(pm.response.json().chat_id).to.eql(pm.collectionVariables.get('chat_id'));",
                  "});",
                  "pm.test('Assistant replied', function () {",
                  "    pm.expect(pm.response.json().message.role).to.eql('assistant');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"bot_profile_id\": \"{{profile_id}}\",\n  \"message\": \"How does multi-tenancy isolation work?\",\n  \"chat_id\": \"{{chat_id}}\"\n}" },
            "url": { "raw": "{{base_url}}/v1/chat", "host": ["{{base_url}}"], "path": ["v1", "chat"] },
            "description": "Send a follow-up message to an existing conversation."
          }
        },
        {
          "name": "Get Chat Metadata",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Chat metadata has expected fields', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json.id).to.eql(pm.collectionVariables.get('chat_id'));",
                  "    pm.expect(json).to.have.property('message_count');",
                  "    pm.expect(json).to.have.property('title');",
                  "    pm.expect(json.message_count).to.be.at.least(2);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/chat/{{chat_id}}", "host": ["{{base_url}}"], "path": ["v1", "chat", "{{chat_id}}"] },
            "description": "Get chat session metadata."
          }
        },
        {
          "name": "Get Chat Messages (History)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "pm.test('Returns array of messages', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json).to.be.an('array');",
                  "    pm.expect(json.length).to.be.at.least(2);",
                  "});",
                  "pm.test('Messages alternate user/assistant', function () {",
                  "    var json = pm.response.json();",
                  "    pm.expect(json[0].role).to.eql('user');",
                  "    pm.expect(json[1].role).to.eql('assistant');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/chat/{{chat_id}}/messages", "host": ["{{base_url}}"], "path": ["v1", "chat", "{{chat_id}}", "messages"] },
            "description": "Get all messages in a chat session."
          }
        },
        {
          "name": "Chat — Invalid Bot Profile (404)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 404', function () {",
                  "    pm.response.to.have.status(404);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"bot_profile_id\": \"00000000-0000-0000-0000-000000000000\",\n  \"message\": \"Hello\"\n}" },
            "url": { "raw": "{{base_url}}/v1/chat", "host": ["{{base_url}}"], "path": ["v1", "chat"] },
            "description": "Chatting with a nonexistent bot_profile_id should return 404."
          }
        },
        {
          "name": "Chat — Invalid Chat ID (404)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 404', function () {",
                  "    pm.response.to.have.status(404);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [ { "key": "Content-Type", "value": "application/json" } ],
            "body": { "mode": "raw", "raw": "{\n  \"bot_profile_id\": \"{{profile_id}}\",\n  \"message\": \"Hello\",\n  \"chat_id\": \"00000000-0000-0000-0000-000000000000\"\n}" },
            "url": { "raw": "{{base_url}}/v1/chat", "host": ["{{base_url}}"], "path": ["v1", "chat"] },
            "description": "Continuing a nonexistent chat session should return 404."
          }
        }
      ]
    },
    {
      "name": "6 — Cleanup",
      "description": "Cleanup: soft-delete resources created during the test run.",
      "item": [
        {
          "name": "Delete Source (Soft)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 204', function () {",
                  "    pm.response.to.have.status(204);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/sources/{{source_id}}", "host": ["{{base_url}}"], "path": ["v1", "sources", "{{source_id}}"] },
            "description": "Soft-delete a source."
          }
        },
        {
          "name": "Delete Bot Profile (Soft)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Status code is 204', function () {",
                  "    pm.response.to.have.status(204);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": { "raw": "{{base_url}}/v1/bot-profiles/{{profile_id}}", "host": ["{{base_url}}"], "path": ["v1", "bot-profiles", "{{profile_id}}"] },
            "description": "Soft-delete a bot profile."
          }
        }
      ]
    }
  ]
}
