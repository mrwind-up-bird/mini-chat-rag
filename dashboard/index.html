<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniRAG Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <link rel="stylesheet" href="/dashboard/css/app.css">
  <script src="/dashboard/js/api.js"></script>
  <script src="/dashboard/js/app.js"></script>
  <script>
    // Chart.js dark theme defaults
    document.addEventListener('DOMContentLoaded', () => {
      if (window.Chart) {
        Chart.defaults.color = 'rgba(255, 255, 255, 0.5)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.06)';
      }
    });
  </script>
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="antialiased" x-data="dashboard()" x-cloak>

  <!-- Animated gradient mesh background -->
  <div class="bg-mesh"><div class="bg-orb"></div></div>

  <!-- ═══ Toast ═══════════════════════════════════════════════ -->
  <div x-show="$store.toast.visible"
       x-transition
       :class="{
         'toast-success': $store.toast.type === 'success',
         'toast-error': $store.toast.type === 'error',
         'toast-info': $store.toast.type === 'info',
       }"
       class="toast" x-text="$store.toast.message"></div>

  <!-- ═══ Login Page ═════════════════════════════════════════ -->
  <template x-if="!$store.auth.isLoggedIn">
    <div class="login-page" x-init="$nextTick(() => { if (window.lucide) lucide.createIcons() })">
      <div class="glass-card-static login-card">
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl mb-4"
               style="background: rgba(139,92,246,0.15); border: 1px solid rgba(139,92,246,0.25);">
            <i data-lucide="message-circle" class="w-8 h-8" style="color: #a78bfa;"></i>
          </div>
          <h1 class="text-2xl font-bold text-white">MiniRAG</h1>
          <p class="text-sm mt-1" style="color: rgba(255,255,255,0.45);">Sign in to your dashboard</p>
        </div>
        <form @submit.prevent="doLogin" class="space-y-4">
          <div>
            <label class="form-label">Email</label>
            <input type="email" x-model="loginForm.email" class="form-input" placeholder="admin@acme.com" required>
          </div>
          <div>
            <label class="form-label">Password</label>
            <input type="password" x-model="loginForm.password" class="form-input" placeholder="********" required>
          </div>
          <div x-show="loginError" class="text-sm" style="color: #fb7185;" x-text="loginError"></div>
          <button type="submit" class="btn-primary w-full" :disabled="loginLoading">
            <span x-show="!loginLoading">Sign In</span>
            <span x-show="loginLoading" class="flex items-center justify-center gap-2">
              <span class="spinner"></span> Signing in...
            </span>
          </button>
        </form>
      </div>
    </div>
  </template>

  <!-- ═══ Authenticated Layout ═══════════════════════════════ -->
  <template x-if="$store.auth.isLoggedIn">
    <div class="app-wrapper flex" x-init="$nextTick(() => { if (window.lucide) lucide.createIcons() })">
      <!-- Sidebar -->
      <aside class="sidebar flex flex-col fixed top-0 left-0 h-screen"
             :class="{ 'open': sidebarOpen }">
        <div class="p-5" style="border-bottom: 1px solid rgba(255,255,255,0.06);">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-lg flex items-center justify-center"
                 style="background: rgba(139,92,246,0.15); border: 1px solid rgba(139,92,246,0.25);">
              <i data-lucide="message-circle" class="w-5 h-5" style="color: #a78bfa;"></i>
            </div>
            <div>
              <div class="font-bold text-white text-sm">MiniRAG</div>
              <div class="text-xs" style="color: rgba(255,255,255,0.35);" x-text="$store.auth.tenant?.name"></div>
            </div>
          </div>
        </div>

        <nav class="flex-1 py-4 space-y-1 px-3 overflow-y-auto">
          <template x-for="item in navItems" :key="item.page">
            <button @click="page = item.page; sidebarOpen = false"
                    :class="page === item.page ? 'active' : ''"
                    class="nav-item">
              <i :data-lucide="item.icon" class="nav-icon"></i>
              <span x-text="item.label"></span>
            </button>
          </template>
        </nav>

        <div class="p-4" style="border-top: 1px solid rgba(255,255,255,0.06);">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold"
                 style="background: rgba(139,92,246,0.5);"
                 x-text="($store.auth.user?.email || '?')[0].toUpperCase()"></div>
            <div class="flex-1 min-w-0">
              <div class="text-sm text-white truncate" x-text="$store.auth.user?.display_name || $store.auth.user?.email"></div>
              <div class="text-xs" style="color: rgba(255,255,255,0.35);" x-text="$store.auth.user?.role"></div>
            </div>
          </div>
          <button @click="$store.auth.logout(); page = 'overview'" class="btn-secondary w-full btn-sm">
            Sign Out
          </button>
        </div>
      </aside>

      <!-- Mobile hamburger -->
      <button @click="sidebarOpen = !sidebarOpen"
              class="lg:hidden fixed top-4 left-4 z-50 p-2 rounded-lg glass-dark text-white">
        <i data-lucide="menu" class="w-5 h-5"></i>
      </button>

      <!-- Main content area -->
      <main class="main-content p-6 lg:p-8 w-full">

        <!-- ── Overview ───────────────────────────────────── -->
        <div x-show="page === 'overview'" x-init="loadOverview()">
          <h2 class="text-2xl font-bold mb-6">Overview</h2>

          <!-- Health cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8" x-show="health">
            <template x-for="[key, val] in Object.entries(health?.postgres ? {postgres: health.postgres, qdrant: health.qdrant, redis: health.redis} : {})" :key="key">
              <div class="stat-card p-4">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-medium capitalize" style="color: rgba(255,255,255,0.5);" x-text="key"></span>
                  <span :class="val.status === 'ok' ? 'badge-ready' : 'badge-error'"
                        class="badge" x-text="val.status"></span>
                </div>
              </div>
            </template>
          </div>

          <!-- Summary stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" x-show="stats">
            <div class="stat-card p-5">
              <div class="text-sm" style="color: rgba(255,255,255,0.5);">Bot Profiles</div>
              <div class="text-2xl font-bold mt-1" x-text="stats?.bot_profiles ?? '—'"></div>
            </div>
            <div class="stat-card p-5">
              <div class="text-sm" style="color: rgba(255,255,255,0.5);">Sources</div>
              <div class="text-2xl font-bold mt-1" x-text="stats?.sources ?? '—'"></div>
            </div>
            <div class="stat-card p-5">
              <div class="text-sm" style="color: rgba(255,255,255,0.5);">Chats</div>
              <div class="text-2xl font-bold mt-1" x-text="stats?.chats ?? '—'"></div>
            </div>
            <div class="stat-card p-5">
              <div class="text-sm" style="color: rgba(255,255,255,0.5);">Total Tokens</div>
              <div class="text-2xl font-bold mt-1" x-text="(stats?.total_tokens ?? 0).toLocaleString()"></div>
            </div>
          </div>

          <!-- Quick actions -->
          <h3 class="text-lg font-semibold mb-3">Quick Actions</h3>
          <div class="flex flex-wrap gap-3">
            <button @click="page = 'bots'" class="btn-primary">Create Bot Profile</button>
            <button @click="page = 'sources'" class="btn-secondary">Add Source</button>
            <button @click="page = 'tokens'" class="btn-secondary">Generate API Token</button>
          </div>
        </div>

        <!-- ── Bot Profiles ───────────────────────────────── -->
        <div x-show="page === 'bots'" x-data="botsPage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">Bot Profiles</h2>
            <button @click="showCreate = true" class="btn-primary">+ New Bot</button>
          </div>

          <!-- Bot cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="bot in bots" :key="bot.id">
              <div class="glass-card p-5">
                <div class="flex items-start justify-between mb-3">
                  <div>
                    <h3 class="font-semibold text-white" x-text="bot.name"></h3>
                    <p class="text-xs mt-0.5" style="color: rgba(255,255,255,0.4);" x-text="bot.model"></p>
                  </div>
                  <span :class="bot.is_active ? 'badge-ready' : 'badge-member'"
                        class="badge" x-text="bot.is_active ? 'Active' : 'Inactive'"></span>
                </div>
                <p class="text-sm mb-3 line-clamp-2" style="color: rgba(255,255,255,0.55);" x-text="bot.description || 'No description'"></p>
                <div class="text-xs mb-3" style="color: rgba(255,255,255,0.3);" x-text="'Temp: ' + bot.temperature + ' | Max tokens: ' + (bot.max_tokens || 'default')"></div>
                <div class="flex gap-2">
                  <button @click="editBot(bot)" class="btn-secondary btn-sm">Edit</button>
                  <button @click="tryBot(bot)" class="btn-success btn-sm">Try It</button>
                  <button @click="showEmbed(bot)" class="btn-secondary btn-sm">Embed</button>
                  <button @click="confirmDeleteBot(bot)" class="btn-danger btn-sm">Delete</button>
                </div>
              </div>
            </template>
          </div>

          <div x-show="bots.length === 0 && !loading" class="empty-state">
            <p>No bot profiles yet. Create your first one!</p>
          </div>

          <!-- Create/Edit Modal -->
          <div x-show="showCreate || editingBot" class="modal-backdrop" @click.self="closeForm()">
            <div class="modal-content p-6">
              <h3 class="text-lg font-bold mb-4" x-text="editingBot ? 'Edit Bot Profile' : 'New Bot Profile'"></h3>
              <form @submit.prevent="saveBot()" class="space-y-4">
                <div>
                  <label class="form-label">Name</label>
                  <input x-model="form.name" class="form-input" required>
                </div>
                <div>
                  <label class="form-label">Description</label>
                  <input x-model="form.description" class="form-input">
                </div>
                <div>
                  <label class="form-label">Model</label>
                  <select x-model="form.model" class="form-input">
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="claude-sonnet-4-5-20250929">claude-sonnet-4-5</option>
                    <option value="claude-haiku-4-5-20251001">claude-haiku-4-5</option>
                    <option value="gemini/gemini-2.0-flash">gemini-2.0-flash</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">System Prompt</label>
                  <textarea x-model="form.system_prompt" class="form-input" rows="4" placeholder="You are a helpful assistant..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="form-label">Temperature: <span x-text="form.temperature"></span></label>
                    <input type="range" x-model.number="form.temperature" min="0" max="2" step="0.1" class="w-full">
                  </div>
                  <div>
                    <label class="form-label">Max Tokens</label>
                    <input type="number" x-model.number="form.max_tokens" class="form-input" placeholder="4096">
                  </div>
                </div>
                <div>
                  <label class="form-label">API Key (optional, encrypted at rest)</label>
                  <input x-model="form.credentials.api_key" class="form-input" type="password" placeholder="sk-...">
                </div>
                <div class="flex justify-end gap-2 pt-2">
                  <button type="button" @click="closeForm()" class="btn-secondary">Cancel</button>
                  <button type="submit" class="btn-primary" :disabled="saving">
                    <span x-show="!saving" x-text="editingBot ? 'Update' : 'Create'"></span>
                    <span x-show="saving" class="spinner"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Embed Snippet Modal -->
          <div x-show="embedBot" class="modal-backdrop" @click.self="embedBot = null">
            <div class="modal-content p-6" style="max-width: 40rem;">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">Embed Widget</h3>
                <button @click="embedBot = null" class="modal-close">&times;</button>
              </div>

              <!-- Tabs -->
              <div class="flex gap-1 mb-4" style="border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: 0;">
                <template x-for="tab in embedTabs" :key="tab.id">
                  <button @click="embedTab = tab.id"
                          :style="embedTab === tab.id
                            ? 'color: #a78bfa; border-bottom: 2px solid #a78bfa; background: none; padding: 0.5rem 0.75rem; font-size: 0.8125rem; font-weight: 500; cursor: pointer; border-top: none; border-left: none; border-right: none;'
                            : 'color: rgba(255,255,255,0.4); border-bottom: 2px solid transparent; background: none; padding: 0.5rem 0.75rem; font-size: 0.8125rem; font-weight: 500; cursor: pointer; border-top: none; border-left: none; border-right: none;'"
                          x-text="tab.label"></button>
                </template>
              </div>

              <!-- Script Tag tab -->
              <div x-show="embedTab === 'script'">
                <p class="text-sm mb-3" style="color: rgba(255,255,255,0.55);">
                  Add a floating chat bubble to any page with a single script tag.
                </p>
                <pre class="code-block overflow-x-auto text-xs mb-3" style="white-space: pre-wrap; word-break: break-all;" x-text="getEmbedSnippet('script')"></pre>
              </div>

              <!-- Custom Element tab -->
              <div x-show="embedTab === 'element'">
                <p class="text-sm mb-3" style="color: rgba(255,255,255,0.55);">
                  Use the custom element for inline placement — position the widget anywhere in your layout.
                </p>
                <pre class="code-block overflow-x-auto text-xs mb-3" style="white-space: pre-wrap; word-break: break-all;" x-text="getEmbedSnippet('element')"></pre>
              </div>

              <!-- Styling tab -->
              <div x-show="embedTab === 'styling'">
                <p class="text-sm mb-3" style="color: rgba(255,255,255,0.55);">
                  Override CSS custom properties to match your brand.
                </p>
                <pre class="code-block overflow-x-auto text-xs mb-3" style="white-space: pre-wrap; word-break: break-all;" x-text="getEmbedSnippet('styling')"></pre>
              </div>

              <p class="text-xs mb-4" style="color: rgba(255,255,255,0.35);">
                Replace <code>YOUR_API_TOKEN</code> with an active API token. You can create one on the
                <button @click="embedBot = null; page = 'tokens'" class="underline" style="color: #a78bfa; background: none; border: none; cursor: pointer; padding: 0; font-size: inherit;">API Tokens</button> page.
              </p>
              <div class="flex justify-end">
                <button @click="copySnippet()" class="btn-primary btn-sm">Copy Snippet</button>
              </div>
            </div>
          </div>

          <!-- Try It chat panel -->
          <div x-show="tryingBot" class="modal-backdrop"
               @click.self="tryingBot = null">
            <div class="modal-content" style="max-width: 48rem;">
              <div class="flex items-center justify-between p-4" style="border-bottom: 1px solid rgba(255,255,255,0.08);">
                <h3 class="font-bold" x-text="'Chat with ' + (tryingBot?.name || '')"></h3>
                <button @click="tryingBot = null; tryChatId = null; tryMessages = []" class="modal-close">&times;</button>
              </div>
              <div class="chat-inline">
                <div class="chat-messages" x-ref="tryChatMessages">
                  <template x-for="msg in tryMessages" :key="msg.id || msg.content">
                    <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                      <template x-if="msg.role === 'user'">
                        <div class="chat-bubble-user" x-text="msg.content"></div>
                      </template>
                      <template x-if="msg.role !== 'user'">
                        <div class="chat-bubble-actions-wrap">
                          <div class="chat-bubble-bot markdown-body" x-html="renderMarkdown(msg.content)"></div>
                          <div class="chat-actions" x-show="msg.id">
                            <button class="chat-action-btn" title="Copy"
                                    @click="copyToClipboard(msg.content); $store.toast.success('Copied to clipboard')">
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                            </button>
                            <button class="chat-action-btn" title="Helpful"
                                    :class="msg.feedback === 'positive' ? 'active-positive' : ''"
                                    @click="let fb = msg.feedback === 'positive' ? null : 'positive'; msg.feedback = fb; API.submitFeedback(tryChatId, msg.id, fb).catch(() => {})">
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>
                            </button>
                            <button class="chat-action-btn" title="Not helpful"
                                    :class="msg.feedback === 'negative' ? 'active-negative' : ''"
                                    @click="let fb = msg.feedback === 'negative' ? null : 'negative'; msg.feedback = fb; API.submitFeedback(tryChatId, msg.id, fb).catch(() => {})">
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"/></svg>
                            </button>
                          </div>
                        </div>
                      </template>
                    </div>
                  </template>
                  <div x-show="trySending" class="flex justify-start">
                    <div class="chat-bubble-bot"><span class="spinner"></span></div>
                  </div>
                </div>
                <div class="chat-input-bar">
                  <input x-model="tryInput" @keydown.enter.prevent="sendTryMessage()"
                         class="form-input flex-1" placeholder="Type a message..." :disabled="trySending">
                  <button @click="sendTryMessage()" class="btn-primary btn-sm" :disabled="trySending || !tryInput.trim()">Send</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ── Sources ────────────────────────────────────── -->
        <div x-show="page === 'sources'" x-data="sourcesPage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">Sources</h2>
            <button @click="showCreate = true" class="btn-primary">+ New Source</button>
          </div>

          <!-- Search & Filters -->
          <div class="flex flex-wrap items-center gap-3 mb-4">
            <div class="flex-1 min-w-[200px]">
              <input type="text" x-model="searchQuery" class="form-input" placeholder="Search by name..."
                     @input.debounce.200ms="">
            </div>
            <select x-model="filterBot" class="form-input" style="width: auto; min-width: 140px;">
              <option value="">All Bots</option>
              <template x-for="bp in botProfiles" :key="bp.id">
                <option :value="bp.id" x-text="bp.name"></option>
              </template>
            </select>
            <select x-model="filterType" class="form-input" style="width: auto; min-width: 120px;">
              <option value="">All Types</option>
              <option value="text">Text</option>
              <option value="url">URL</option>
              <option value="upload">Upload</option>
            </select>
            <select x-model="filterStatus" class="form-input" style="width: auto; min-width: 130px;">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="ready">Ready</option>
              <option value="error">Error</option>
            </select>
            <button x-show="searchQuery || filterBot || filterType || filterStatus"
                    @click="searchQuery = ''; filterBot = ''; filterType = ''; filterStatus = ''"
                    class="btn-secondary btn-sm" style="white-space: nowrap;">Clear</button>
          </div>

          <div class="glass-table-wrap">
            <table class="data-table">
              <thead><tr>
                <th>Name</th><th>Bot</th><th>Type</th><th>Status</th><th>Chunks</th><th>Created</th><th></th>
              </tr></thead>
              <tbody>
                <template x-for="row in displayRows" :key="row._key">
                  <tr :style="row._isChild ? 'background: rgba(255,255,255,0.02)' : ''">
                    <td class="font-medium text-white">
                      <div class="flex items-center gap-2" :style="row._isChild ? 'padding-left: 1.5rem' : ''">
                        <button x-show="row.children_count > 0" @click="toggleExpand(row)"
                                class="p-0.5 rounded hover:bg-white/10 transition-transform flex-shrink-0"
                                :style="expandedParents[row.id] ? 'transform:rotate(90deg)' : ''">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"/>
                          </svg>
                        </button>
                        <span x-show="row._isChild" style="color: rgba(255,255,255,0.25); margin-right: 0.25rem;">&#8627;</span>
                        <span x-text="truncate(row.name, 50)" :title="row.name"></span>
                        <span x-show="row.children_count > 0" class="badge badge-member text-xs" x-text="row.children_count + ' items'"></span>
                      </div>
                    </td>
                    <td class="text-xs" style="color: rgba(255,255,255,0.5);" x-text="botName(row.bot_profile_id)"></td>
                    <td><span class="badge badge-member" x-text="row.source_type"></span></td>
                    <td><span :class="'badge badge-' + row.status" x-text="row.status"></span></td>
                    <td x-text="row.chunk_count"></td>
                    <td class="text-xs" style="color: rgba(255,255,255,0.4);" x-text="formatDate(row.created_at)"></td>
                    <td class="text-right space-x-1">
                      <button x-show="row.children_count > 0" @click="ingestChildren(row)" class="btn-success btn-sm"
                              :disabled="row.status === 'processing'">Ingest All</button>
                      <button x-show="!row._isChild && row.children_count === 0" @click="ingest(row)" class="btn-success btn-sm"
                              :disabled="row.status === 'processing'">Ingest</button>
                      <button x-show="row._isChild" @click="ingest(row)" class="btn-success btn-sm"
                              :disabled="row.status === 'processing'">Ingest</button>
                      <button x-show="!row._isChild" @click="confirmDelete(row)" class="btn-danger btn-sm">Delete</button>
                      <button x-show="row._isChild" @click="confirmDeleteChild(row)" class="btn-danger btn-sm">Delete</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="displayRows.length === 0 && !loading" class="empty-state">
              <p x-text="sources.length === 0 ? 'No sources yet.' : 'No sources match your filters.'"></p>
            </div>
          </div>

          <!-- Create Source Modal -->
          <div x-show="showCreate" class="modal-backdrop" @click.self="showCreate = false">
            <div class="modal-content p-6">
              <h3 class="text-lg font-bold mb-4">New Source</h3>
              <form @submit.prevent="createSource()" class="space-y-4">
                <div>
                  <label class="form-label">Bot Profile</label>
                  <select x-model="form.bot_profile_id" class="form-input" required>
                    <option value="">Select a bot...</option>
                    <template x-for="bp in botProfiles" :key="bp.id">
                      <option :value="bp.id" x-text="bp.name"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label class="form-label">Name</label>
                  <input x-model="form.name" class="form-input" required>
                </div>
                <div>
                  <label class="form-label">Type</label>
                  <select x-model="form.source_type" class="form-input">
                    <option value="text">Text</option>
                    <option value="url">URL</option>
                    <option value="upload">Upload</option>
                  </select>
                </div>
                <div x-show="form.source_type === 'text'">
                  <label class="form-label">Content</label>
                  <textarea x-model="form.content" class="form-input" rows="6" placeholder="Paste your knowledge base text..."></textarea>
                </div>
                <div x-show="form.source_type === 'url'">
                  <label class="form-label">URLs <span class="text-xs opacity-60">(one per line, or comma-separated)</span></label>
                  <textarea x-model="form.config.urls" class="form-input" rows="4"
                            placeholder="https://example.com/page1&#10;https://example.com/page2"></textarea>
                </div>
                <div x-show="form.source_type === 'upload'">
                  <label class="form-label">Files</label>
                  <div class="drop-zone"
                       :class="{ 'dragover': dragover }"
                       @click="$refs.fileInput.click()"
                       @dragover.prevent="dragover = true"
                       @dragleave.prevent="dragover = false"
                       @drop.prevent="dragover = false; handleFileDrop($event)">
                    <div class="text-center">
                      <div class="drop-zone-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                          <polyline points="17 8 12 3 7 8"/>
                          <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                      </div>
                      <p class="drop-zone-text">Drop files here or click to browse</p>
                      <p class="text-xs mt-1" style="color: rgba(255,255,255,0.3);">PDF, DOCX, TXT, MD, CSV (max 10 MB each)</p>
                    </div>
                    <input type="file" x-ref="fileInput" class="hidden" multiple
                           accept=".pdf,.docx,.txt,.md,.csv"
                           @change="handleFileSelect($event)">
                  </div>
                  <template x-if="uploadFiles.length > 0">
                    <div class="file-list">
                      <template x-for="(f, idx) in uploadFiles" :key="f.name + f.size">
                        <div class="file-preview">
                          <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                 style="color: #a78bfa; flex-shrink: 0;">
                              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                              <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            <div class="flex-1 min-w-0">
                              <p class="text-sm font-medium text-white truncate" x-text="f.name"></p>
                              <p class="text-xs" style="color: rgba(255,255,255,0.4);" x-text="formatFileSize(f.size)"></p>
                            </div>
                            <button type="button" @click="removeFile(idx)" class="modal-close text-sm">&times;</button>
                          </div>
                        </div>
                      </template>
                      <button type="button" @click="uploadFiles = []"
                              class="text-xs mt-1" style="color: rgba(255,255,255,0.35); background: none; border: none; cursor: pointer; padding: 0;">
                        Clear all
                      </button>
                    </div>
                  </template>
                </div>
                <template x-if="uploading">
                  <div>
                    <div class="flex items-center justify-between mb-1">
                      <span class="text-xs" style="color: rgba(255,255,255,0.5);" x-text="uploadStatus"></span>
                      <span class="text-xs font-medium" style="color: #a78bfa;" x-text="uploadProgress + '/' + uploadFiles.length"></span>
                    </div>
                    <div class="upload-progress"><div class="upload-progress-bar" :style="'width:' + Math.round((uploadProgress / uploadFiles.length) * 100) + '%'"></div></div>
                  </div>
                </template>
                <div class="flex justify-end gap-2">
                  <button type="button" @click="showCreate = false" class="btn-secondary">Cancel</button>
                  <button type="submit" class="btn-primary" :disabled="saving || uploading">
                    <span x-show="!uploading" x-text="form.source_type === 'upload' ? (uploadFiles.length > 1 ? 'Upload ' + uploadFiles.length + ' Files' : 'Upload') : 'Create'"></span>
                    <span x-show="uploading" class="flex items-center gap-2"><span class="spinner"></span> Uploading...</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- ── Chat History ───────────────────────────────── -->
        <div x-show="page === 'chats'" x-data="chatsPage()" x-init="load()">
          <h2 class="text-2xl font-bold mb-6">Chat History</h2>

          <div class="glass-table-wrap">
            <table class="data-table">
              <thead><tr>
                <th>Title</th><th>Messages</th><th>Tokens</th><th>Created</th><th></th>
              </tr></thead>
              <tbody>
                <template x-for="c in chats" :key="c.id">
                  <tr>
                    <td class="font-medium text-white" x-text="truncate(c.title, 50)"></td>
                    <td x-text="c.message_count"></td>
                    <td x-text="(c.total_prompt_tokens + c.total_completion_tokens).toLocaleString()"></td>
                    <td class="text-xs" style="color: rgba(255,255,255,0.4);" x-text="formatDate(c.created_at)"></td>
                    <td class="text-right">
                      <button @click="viewChat(c)" class="btn-secondary btn-sm">View</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="chats.length === 0 && !loading" class="empty-state"><p>No chats yet.</p></div>
          </div>

          <!-- Chat detail modal -->
          <div x-show="selectedChat" class="modal-backdrop" @click.self="selectedChat = null; messages = []">
            <div class="modal-content" style="max-width:48rem;">
              <div class="p-4 flex items-center justify-between" style="border-bottom: 1px solid rgba(255,255,255,0.08);">
                <h3 class="font-bold" x-text="selectedChat?.title"></h3>
                <button @click="selectedChat = null; messages = []" class="modal-close">&times;</button>
              </div>
              <div class="p-4 space-y-3 max-h-96 overflow-y-auto">
                <template x-for="m in messages" :key="m.id">
                  <div :class="m.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                    <template x-if="m.role === 'user'">
                      <div class="chat-bubble-user" x-text="m.content"></div>
                    </template>
                    <template x-if="m.role !== 'user'">
                      <div class="chat-bubble-actions-wrap">
                        <div class="chat-bubble-bot markdown-body" x-html="renderMarkdown(m.content)"></div>
                        <div class="chat-actions">
                          <button class="chat-action-btn" title="Copy"
                                  @click="copyToClipboard(m.content); $store.toast.success('Copied to clipboard')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                          </button>
                          <button class="chat-action-btn" title="Helpful"
                                  :class="m.feedback === 'positive' ? 'active-positive' : ''"
                                  @click="let fb = m.feedback === 'positive' ? null : 'positive'; m.feedback = fb; API.submitFeedback(selectedChat.id, m.id, fb).catch(() => {})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>
                          </button>
                          <button class="chat-action-btn" title="Not helpful"
                                  :class="m.feedback === 'negative' ? 'active-negative' : ''"
                                  @click="let fb = m.feedback === 'negative' ? null : 'negative'; m.feedback = fb; API.submitFeedback(selectedChat.id, m.id, fb).catch(() => {})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"/></svg>
                          </button>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- ── API Tokens ─────────────────────────────────── -->
        <div x-show="page === 'tokens'" x-data="tokensPage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">API Tokens</h2>
            <button @click="showCreate = true" class="btn-primary">+ New Token</button>
          </div>

          <!-- Newly created token banner -->
          <div x-show="newToken" class="alert-success mb-6">
            <p class="text-sm font-medium mb-2" style="color: #34d399;">Token created! Copy it now — it won't be shown again.</p>
            <div class="flex items-center gap-2">
              <code class="code-block flex-1 overflow-x-auto" x-text="newToken"></code>
              <button @click="copyToClipboard(newToken)" class="btn-primary btn-sm">Copy</button>
            </div>
          </div>

          <div class="glass-table-wrap">
            <table class="data-table">
              <thead><tr>
                <th>Name</th><th>Prefix</th><th>Active</th><th>Last Used</th><th></th>
              </tr></thead>
              <tbody>
                <template x-for="t in tokens" :key="t.id">
                  <tr>
                    <td class="font-medium text-white" x-text="t.name"></td>
                    <td><code class="code-inline" x-text="t.token_prefix + '...'"></code></td>
                    <td><span :class="t.is_active ? 'badge-ready' : 'badge-error'" class="badge" x-text="t.is_active ? 'Active' : 'Revoked'"></span></td>
                    <td class="text-xs" style="color: rgba(255,255,255,0.4);" x-text="formatDate(t.last_used_at)"></td>
                    <td class="text-right">
                      <button x-show="t.is_active" @click="revoke(t)" class="btn-danger btn-sm">Revoke</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="tokens.length === 0 && !loading" class="empty-state"><p>No API tokens.</p></div>
          </div>

          <!-- Create Token Modal -->
          <div x-show="showCreate" class="modal-backdrop" @click.self="showCreate = false">
            <div class="modal-content p-6">
              <h3 class="text-lg font-bold mb-4">New API Token</h3>
              <form @submit.prevent="createToken()" class="space-y-4">
                <div>
                  <label class="form-label">Name</label>
                  <input x-model="form.name" class="form-input" required placeholder="e.g. production-widget">
                </div>
                <div class="flex justify-end gap-2">
                  <button type="button" @click="showCreate = false" class="btn-secondary">Cancel</button>
                  <button type="submit" class="btn-primary">Create</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- ── Users ──────────────────────────────────────── -->
        <div x-show="page === 'users'" x-data="usersPage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">Users</h2>
            <button x-show="$store.auth.isAdmin" @click="showCreate = true" class="btn-primary">+ New User</button>
          </div>

          <div class="glass-table-wrap">
            <table class="data-table">
              <thead><tr>
                <th>Email</th><th>Name</th><th>Role</th><th>Status</th><th></th>
              </tr></thead>
              <tbody>
                <template x-for="u in users" :key="u.id">
                  <tr>
                    <td class="font-medium text-white" x-text="u.email"></td>
                    <td x-text="u.display_name || '—'"></td>
                    <td><span :class="'badge badge-' + u.role" x-text="u.role"></span></td>
                    <td><span :class="u.is_active ? 'badge-ready' : 'badge-error'" class="badge" x-text="u.is_active ? 'Active' : 'Disabled'"></span></td>
                    <td class="text-right">
                      <button x-show="$store.auth.isAdmin && u.is_active && u.id !== $store.auth.user.id"
                              @click="deactivate(u)" class="btn-danger btn-sm">Deactivate</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="users.length === 0 && !loading" class="empty-state"><p>No users found.</p></div>
          </div>

          <!-- Create User Modal -->
          <div x-show="showCreate" class="modal-backdrop" @click.self="showCreate = false">
            <div class="modal-content p-6">
              <h3 class="text-lg font-bold mb-4">New User</h3>
              <form @submit.prevent="createUser()" class="space-y-4">
                <div>
                  <label class="form-label">Email</label>
                  <input type="email" x-model="form.email" class="form-input" required>
                </div>
                <div>
                  <label class="form-label">Password</label>
                  <input type="password" x-model="form.password" class="form-input" required minlength="8">
                </div>
                <div>
                  <label class="form-label">Display Name</label>
                  <input x-model="form.display_name" class="form-input">
                </div>
                <div>
                  <label class="form-label">Role</label>
                  <select x-model="form.role" class="form-input">
                    <option value="member">Member</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
                <div class="flex justify-end gap-2">
                  <button type="button" @click="showCreate = false" class="btn-secondary">Cancel</button>
                  <button type="submit" class="btn-primary">Create</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- ── Usage ──────────────────────────────────────── -->
        <div x-show="page === 'usage'" x-data="usagePage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">Usage & Analytics</h2>
            <select x-model="selectedDays" @change="load()"
                    style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 0.4rem 0.75rem; border-radius: 0.5rem; font-size: 0.8125rem; cursor: pointer; outline: none;">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="">All time</option>
            </select>
          </div>

          <!-- Cost summary cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" x-show="costEstimate && !loading">
            <div class="stat-card p-5">
              <div class="text-sm" style="color: rgba(255,255,255,0.5);">Total Cost</div>
              <div class="text-2xl font-bold mt-1" x-text="formatUsd(costEstimate?.total_cost_usd)"></div>
              <div class="text-xs mt-1" style="color: rgba(255,255,255,0.3);" x-text="'Last ' + (costEstimate?.active_days || 0) + ' active days'"></div>
            </div>
            <div class="stat-card p-5">
              <div class="text-sm" style="color: rgba(255,255,255,0.5);">Daily Average</div>
              <div class="text-2xl font-bold mt-1" x-text="formatUsd(costEstimate?.daily_avg_cost_usd)"></div>
              <div class="text-xs mt-1" style="color: rgba(255,255,255,0.3);">Per active day</div>
            </div>
            <div class="stat-card p-5">
              <div class="text-sm" style="color: rgba(255,255,255,0.5);">Projected Monthly</div>
              <div class="text-2xl font-bold mt-1" style="color: #a78bfa;" x-text="formatUsd(costEstimate?.projected_monthly_usd)"></div>
              <div class="text-xs mt-1" style="color: rgba(255,255,255,0.3);">Based on current pace</div>
            </div>
            <div class="stat-card p-5">
              <div class="text-sm" style="color: rgba(255,255,255,0.5);">Total Requests</div>
              <div class="text-2xl font-bold mt-1" x-text="totalRequests.toLocaleString()"></div>
              <div class="text-xs mt-1" style="color: rgba(255,255,255,0.3);">LLM completions</div>
            </div>
          </div>

          <!-- Loading skeleton -->
          <template x-if="loading">
            <div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <template x-for="i in 4" :key="i">
                  <div class="stat-card p-5">
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                    <div class="skeleton skeleton-heading mt-2"></div>
                    <div class="skeleton skeleton-text mt-2" style="width: 50%;"></div>
                  </div>
                </template>
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glass-card-static p-5">
                  <div class="skeleton skeleton-text mb-3" style="width: 40%;"></div>
                  <div class="skeleton" style="height: 200px; border-radius: 8px;"></div>
                </div>
                <div class="glass-card-static p-5">
                  <div class="skeleton skeleton-text mb-3" style="width: 40%;"></div>
                  <div class="skeleton" style="height: 200px; border-radius: 8px;"></div>
                </div>
              </div>
            </div>
          </template>

          <!-- Charts -->
          <div x-show="!loading" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass-card-static p-5">
              <h3 class="font-semibold mb-3" x-text="'Token Usage by Day (' + dateRangeLabel + ')'"></h3>
              <canvas x-ref="dailyChart" height="200"></canvas>
              <div x-show="usageData.length === 0" class="empty-state" style="padding: 24px 16px;"><p>No token data for this period.</p></div>
            </div>
            <div class="glass-card-static p-5">
              <h3 class="font-semibold mb-3" x-text="'Cost by Model (' + dateRangeLabel + ')'"></h3>
              <canvas x-ref="modelChart" height="200"></canvas>
              <div x-show="modelData.length === 0" class="empty-state" style="padding: 24px 16px;"><p>No model data for this period.</p></div>
            </div>
          </div>

          <!-- Tabs for breakdown tables -->
          <div class="flex gap-1 mb-4" style="border-bottom: 1px solid rgba(255,255,255,0.08);">
            <template x-for="tab in tabs" :key="tab.id">
              <button @click="activeTab = tab.id"
                      :style="activeTab === tab.id
                        ? 'color: #a78bfa; border-bottom: 2px solid #a78bfa; background: none; padding: 0.5rem 0.75rem; font-size: 0.8125rem; font-weight: 500; cursor: pointer; border-top: none; border-left: none; border-right: none;'
                        : 'color: rgba(255,255,255,0.4); border-bottom: 2px solid transparent; background: none; padding: 0.5rem 0.75rem; font-size: 0.8125rem; font-weight: 500; cursor: pointer; border-top: none; border-left: none; border-right: none;'"
                      x-text="tab.label"></button>
            </template>
          </div>

          <!-- By Model tab -->
          <div x-show="activeTab === 'model'">
            <div class="glass-table-wrap">
              <table class="data-table">
                <thead><tr>
                  <th>Model</th><th>Requests</th><th>Prompt</th><th>Completion</th><th>Total</th><th>Rate ($/1M)</th><th class="text-right">Cost</th>
                </tr></thead>
                <tbody>
                  <template x-for="row in modelData" :key="row.model">
                    <tr>
                      <td class="font-medium text-white" x-text="row.model"></td>
                      <td x-text="row.request_count.toLocaleString()"></td>
                      <td x-text="row.prompt_tokens.toLocaleString()"></td>
                      <td x-text="row.completion_tokens.toLocaleString()"></td>
                      <td x-text="row.total_tokens.toLocaleString()"></td>
                      <td class="text-xs" style="color: rgba(255,255,255,0.4);" x-text="'$' + row.prompt_cost_per_1m + ' / $' + row.completion_cost_per_1m"></td>
                      <td class="text-right font-medium" style="color: #a78bfa;" x-text="formatUsd(row.cost_usd)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
              <div x-show="modelData.length === 0 && !loading" class="empty-state"><p>No usage data yet.</p></div>
            </div>
          </div>

          <!-- By Bot tab -->
          <div x-show="activeTab === 'bot'">
            <div class="glass-table-wrap">
              <table class="data-table">
                <thead><tr>
                  <th>Bot</th><th>Model</th><th>Requests</th><th>Prompt</th><th>Completion</th><th>Total</th><th class="text-right">Cost</th>
                </tr></thead>
                <tbody>
                  <template x-for="row in botData" :key="row.bot_profile_id + row.model">
                    <tr>
                      <td class="font-medium text-white" x-text="row.bot_name"></td>
                      <td class="text-xs" style="color: rgba(255,255,255,0.5);" x-text="row.model"></td>
                      <td x-text="row.request_count.toLocaleString()"></td>
                      <td x-text="row.prompt_tokens.toLocaleString()"></td>
                      <td x-text="row.completion_tokens.toLocaleString()"></td>
                      <td x-text="row.total_tokens.toLocaleString()"></td>
                      <td class="text-right font-medium" style="color: #a78bfa;" x-text="formatUsd(row.cost_usd)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
              <div x-show="botData.length === 0 && !loading" class="empty-state"><p>No usage data yet.</p></div>
            </div>
          </div>

          <!-- Daily tab -->
          <div x-show="activeTab === 'daily'">
            <div class="glass-table-wrap">
              <table class="data-table">
                <thead><tr>
                  <th>Date</th><th>Model</th><th>Requests</th><th>Prompt</th><th>Completion</th><th>Total</th><th class="text-right">Est. Cost</th>
                </tr></thead>
                <tbody>
                  <template x-for="row in usageData" :key="row.date + row.model">
                    <tr>
                      <td x-text="row.date"></td>
                      <td x-text="row.model"></td>
                      <td x-text="row.request_count.toLocaleString()"></td>
                      <td x-text="row.prompt_tokens.toLocaleString()"></td>
                      <td x-text="row.completion_tokens.toLocaleString()"></td>
                      <td x-text="row.total_tokens.toLocaleString()"></td>
                      <td class="text-right font-medium" style="color: #a78bfa;" x-text="formatUsd(calcRowCost(row))"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
              <div x-show="usageData.length === 0 && !loading" class="empty-state"><p>No usage data yet.</p></div>
            </div>
          </div>
        </div>

        <!-- ── Settings ───────────────────────────────────── -->
        <div x-show="page === 'settings'" x-data="settingsPage()" x-init="load()">
          <h2 class="text-2xl font-bold mb-6">Settings</h2>

          <div class="space-y-6">
            <!-- Tenant info -->
            <div class="glass-card-static p-6">
              <h3 class="font-semibold mb-4">Tenant Information</h3>
              <dl class="grid grid-cols-2 gap-4 text-sm">
                <div><dt style="color: rgba(255,255,255,0.45);">Name</dt><dd class="font-medium mt-1" x-text="$store.auth.tenant?.name"></dd></div>
                <div><dt style="color: rgba(255,255,255,0.45);">Slug</dt><dd class="font-medium mt-1" x-text="$store.auth.tenant?.slug"></dd></div>
                <div><dt style="color: rgba(255,255,255,0.45);">Plan</dt><dd class="font-medium mt-1" x-text="$store.auth.tenant?.plan"></dd></div>
                <div><dt style="color: rgba(255,255,255,0.45);">Status</dt>
                  <dd class="mt-1"><span :class="$store.auth.tenant?.is_active ? 'badge-ready' : 'badge-error'" class="badge"
                            x-text="$store.auth.tenant?.is_active ? 'Active' : 'Disabled'"></span></dd>
                </div>
              </dl>
            </div>

            <!-- System health -->
            <div class="glass-card-static p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold">System Health</h3>
                <button @click="checkHealth()" class="btn-secondary btn-sm">Refresh</button>
              </div>
              <div class="space-y-3" x-show="health">
                <template x-for="[svc, info] in Object.entries(health || {})" :key="svc">
                  <div x-show="svc !== 'status'" class="flex items-center justify-between py-2" style="border-bottom: 1px solid rgba(255,255,255,0.06);">
                    <span class="capitalize font-medium text-sm" x-text="svc"></span>
                    <div class="flex items-center gap-2">
                      <span :class="info.status === 'ok' ? 'bg-emerald-500' : 'bg-rose-500'"
                            :style="info.status === 'ok' ? 'box-shadow: 0 0 8px rgba(16,185,129,0.5)' : 'box-shadow: 0 0 8px rgba(244,63,94,0.5)'"
                            class="w-2.5 h-2.5 rounded-full"></span>
                      <span class="text-sm" style="color: rgba(255,255,255,0.65);" x-text="info.status === 'ok' ? 'Connected' : info.detail || 'Error'"></span>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- App info -->
            <div class="glass-card-static p-6">
              <h3 class="font-semibold mb-4">Application</h3>
              <dl class="grid grid-cols-2 gap-4 text-sm">
                <div><dt style="color: rgba(255,255,255,0.45);">Version</dt><dd class="font-medium mt-1">0.1.0</dd></div>
                <div><dt style="color: rgba(255,255,255,0.45);">API Docs</dt><dd class="mt-1"><a href="/docs" target="_blank" class="hover:underline">/docs</a></dd></div>
              </dl>
            </div>
          </div>
        </div>

      </main>
    </div>
  </template>

  <!-- ═══ Alpine.js Components ═══════════════════════════════ -->
  <script>
    function dashboard() {
      return {
        page: 'overview',
        sidebarOpen: false,
        loginForm: { email: '', password: '' },
        loginError: '',
        loginLoading: false,
        health: null,
        stats: null,

        navItems: [
          { page: 'overview', label: 'Overview', icon: 'layout-dashboard' },
          { page: 'bots', label: 'Bot Profiles', icon: 'bot' },
          { page: 'sources', label: 'Sources', icon: 'database' },
          { page: 'chats', label: 'Chat History', icon: 'message-square' },
          { page: 'tokens', label: 'API Tokens', icon: 'key-round' },
          { page: 'users', label: 'Users', icon: 'users' },
          { page: 'usage', label: 'Usage', icon: 'bar-chart-3' },
          { page: 'settings', label: 'Settings', icon: 'settings' },
        ],

        async doLogin() {
          this.loginError = '';
          this.loginLoading = true;
          try {
            await Alpine.store('auth').login(this.loginForm.email, this.loginForm.password);
            this.page = 'overview';
            this.loginForm = { email: '', password: '' };
          } catch (e) {
            this.loginError = e.message;
          } finally {
            this.loginLoading = false;
          }
        },

        async loadOverview() {
          try {
            [this.health, this.stats] = await Promise.all([
              API.getSystemHealth().catch(() => null),
              API.getOverview().catch(() => null),
            ]);
          } catch {}
        },
      };
    }

    function botsPage() {
      return {
        bots: [],
        loading: false,
        showCreate: false,
        editingBot: null,
        saving: false,
        form: { name: '', description: '', model: 'gpt-4o-mini', system_prompt: '', temperature: 0.7, max_tokens: null, credentials: {} },
        tryingBot: null,
        tryChatId: null,
        tryMessages: [],
        tryInput: '',
        trySending: false,
        embedBot: null,
        embedTab: 'script',
        embedTabs: [
          { id: 'script', label: 'Script Tag' },
          { id: 'element', label: 'Custom Element' },
          { id: 'styling', label: 'Styling' },
        ],

        async load() {
          this.loading = true;
          try { this.bots = await API.listBotProfiles(); } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        editBot(bot) {
          this.editingBot = bot;
          this.form = {
            name: bot.name,
            description: bot.description || '',
            model: bot.model,
            system_prompt: bot.system_prompt || '',
            temperature: bot.temperature,
            max_tokens: bot.max_tokens,
            credentials: {},
          };
        },

        closeForm() {
          this.showCreate = false;
          this.editingBot = null;
          this.form = { name: '', description: '', model: 'gpt-4o-mini', system_prompt: '', temperature: 0.7, max_tokens: null, credentials: {} };
        },

        async saveBot() {
          this.saving = true;
          try {
            const data = { ...this.form };
            if (!data.credentials?.api_key) delete data.credentials;
            if (!data.max_tokens) delete data.max_tokens;

            if (this.editingBot) {
              await API.updateBotProfile(this.editingBot.id, data);
              Alpine.store('toast').success('Bot profile updated');
            } else {
              await API.createBotProfile(data);
              Alpine.store('toast').success('Bot profile created');
            }
            this.closeForm();
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
          this.saving = false;
        },

        async confirmDeleteBot(bot) {
          if (!confirm(`Deactivate "${bot.name}"?`)) return;
          try {
            await API.deleteBotProfile(bot.id);
            Alpine.store('toast').success('Bot profile deactivated');
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        tryBot(bot) {
          this.tryingBot = bot;
          this.tryChatId = null;
          this.tryMessages = [];
          this.tryInput = '';
        },

        async sendTryMessage() {
          const msg = this.tryInput.trim();
          if (!msg || this.trySending) return;
          this.tryInput = '';
          this.tryMessages.push({ role: 'user', content: msg });
          this.trySending = true;

          // Create a placeholder assistant message for streaming
          const assistantMsg = { role: 'assistant', content: '', id: null, feedback: null, streaming: true };
          this.tryMessages.push(assistantMsg);

          const scrollToBottom = () => {
            this.$nextTick(() => {
              const el = this.$refs.tryChatMessages;
              if (el) el.scrollTop = el.scrollHeight;
            });
          };

          try {
            await API.sendMessageStream(this.tryingBot.id, msg, this.tryChatId, {
              onDelta: (content) => {
                assistantMsg.content += content;
                scrollToBottom();
              },
              onSources: (sources) => {
                assistantMsg.sources = sources;
              },
              onDone: (data) => {
                this.tryChatId = data.chat_id;
                assistantMsg.id = data.message_id;
                assistantMsg.streaming = false;
                this.trySending = false;
                scrollToBottom();
              },
              onError: (detail) => {
                if (!assistantMsg.content) {
                  assistantMsg.content = `Error: ${detail}`;
                }
                assistantMsg.streaming = false;
                this.trySending = false;
                scrollToBottom();
              },
            });
          } catch (e) {
            assistantMsg.content = `Error: ${e.message}`;
            assistantMsg.streaming = false;
            this.trySending = false;
            scrollToBottom();
          }
        },

        showEmbed(bot) {
          this.embedBot = bot;
          this.embedTab = 'script';
        },

        getEmbedSnippet(tab) {
          if (!this.embedBot) return '';
          const origin = window.location.origin;
          const id = this.embedBot.id;
          const name = this.embedBot.name;
          if (tab === 'element') {
            return `<!-- Load the widget script -->\n<script src="${origin}/dashboard/widget/minirag-widget.js"><\/script>\n\n<!-- Place wherever you want the chat to appear -->\n<minirag-widget\n  bot-id="${id}"\n  api-url="${origin}"\n  api-token="YOUR_API_TOKEN"\n  title="${name}">\n</minirag-widget>`;
          }
          if (tab === 'styling') {
            return `<style>\n  minirag-widget {\n    --primary: #4f46e5;\n    --primary-hover: #4338ca;\n    --bg: #ffffff;\n    --bg-secondary: #f3f4f6;\n    --text: #111827;\n    --text-secondary: #6b7280;\n    --border: #e5e7eb;\n    --radius: 12px;\n  }\n</style>`;
          }
          return `<script src="${origin}/dashboard/widget/minirag-widget.js"\n        data-bot-id="${id}"\n        data-api-url="${origin}"\n        data-api-token="YOUR_API_TOKEN"\n        data-title="${name}">\n<\/script>`;
        },

        async copySnippet() {
          try {
            await navigator.clipboard.writeText(this.getEmbedSnippet(this.embedTab));
            Alpine.store('toast').success('Snippet copied to clipboard');
          } catch {
            Alpine.store('toast').error('Failed to copy snippet');
          }
        },
      };
    }

    function sourcesPage() {
      return {
        sources: [],
        botProfiles: [],
        loading: false,
        showCreate: false,
        saving: false,
        form: { bot_profile_id: '', name: '', source_type: 'text', content: '', config: {} },
        uploadFiles: [],
        uploading: false,
        uploadProgress: 0,
        uploadStatus: '',
        dragover: false,
        childrenMap: {},
        expandedParents: {},
        searchQuery: '',
        filterBot: '',
        filterType: '',
        filterStatus: '',

        get filteredSources() {
          let result = this.sources;
          const q = this.searchQuery.toLowerCase().trim();
          if (q) {
            result = result.filter(s => {
              if (s.name.toLowerCase().includes(q)) return true;
              // Also match if any child name matches (for parents)
              const children = this.childrenMap[s.id];
              if (children) return children.some(c => c.name.toLowerCase().includes(q));
              return false;
            });
          }
          if (this.filterBot) {
            result = result.filter(s => s.bot_profile_id === this.filterBot);
          }
          if (this.filterType) {
            result = result.filter(s => s.source_type === this.filterType);
          }
          if (this.filterStatus) {
            result = result.filter(s => s.status === this.filterStatus);
          }
          return result;
        },

        get displayRows() {
          const rows = [];
          const q = this.searchQuery.toLowerCase().trim();
          for (const src of this.filteredSources) {
            rows.push({ ...src, _isChild: false, _key: src.id });
            if (src.children_count > 0 && this.expandedParents[src.id] && this.childrenMap[src.id]) {
              let children = this.childrenMap[src.id];
              // Filter children by search query too
              if (q) children = children.filter(c => c.name.toLowerCase().includes(q));
              for (const child of children) {
                rows.push({ ...child, _isChild: true, _parentId: src.id, _key: 'child-' + child.id });
              }
            }
          }
          return rows;
        },

        botName(bpId) {
          const bp = this.botProfiles.find(b => b.id === bpId);
          return bp ? bp.name : '—';
        },

        async load() {
          this.loading = true;
          try {
            [this.sources, this.botProfiles] = await Promise.all([
              API.listSources(),
              API.listBotProfiles(),
            ]);
            // Reload children for any expanded parents
            for (const parentId of Object.keys(this.expandedParents)) {
              if (this.expandedParents[parentId]) {
                try {
                  this.childrenMap[parentId] = await API.listSourceChildren(parentId);
                } catch { /* parent may have been deleted */ }
              }
            }
          } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        async toggleExpand(src) {
          if (this.expandedParents[src.id]) {
            this.expandedParents[src.id] = false;
            return;
          }
          try {
            this.childrenMap[src.id] = await API.listSourceChildren(src.id);
            this.expandedParents[src.id] = true;
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        handleFileSelect(event) {
          for (const file of event.target.files) {
            this.validateAndAddFile(file);
          }
          event.target.value = '';
        },

        handleFileDrop(event) {
          for (const file of event.dataTransfer.files) {
            this.validateAndAddFile(file);
          }
        },

        validateAndAddFile(file) {
          const allowed = ['.pdf', '.docx', '.txt', '.md', '.csv'];
          const ext = '.' + file.name.split('.').pop().toLowerCase();
          if (!allowed.includes(ext)) {
            Alpine.store('toast').error(`Unsupported file type: ${ext}`);
            return;
          }
          if (file.size > 10 * 1024 * 1024) {
            Alpine.store('toast').error(`${file.name} is too large. Maximum 10 MB.`);
            return;
          }
          if (this.uploadFiles.some(f => f.name === file.name && f.size === file.size)) return;
          this.uploadFiles.push(file);
        },

        removeFile(idx) {
          this.uploadFiles.splice(idx, 1);
        },

        formatFileSize(bytes) {
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        },

        async createSource() {
          if (this.form.source_type === 'upload') {
            await this.uploadSource();
            return;
          }
          if (this.form.source_type === 'url') {
            await this.createUrlSources();
            return;
          }
          this.saving = true;
          try {
            const data = {
              bot_profile_id: this.form.bot_profile_id,
              name: this.form.name,
              source_type: this.form.source_type,
            };
            if (this.form.source_type === 'text') {
              data.content = this.form.content;
            }
            await API.createSource(data);
            Alpine.store('toast').success('Source created');
            this.showCreate = false;
            this.form = { bot_profile_id: '', name: '', source_type: 'text', content: '', config: {} };
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
          this.saving = false;
        },

        async createUrlSources() {
          const raw = (this.form.config.urls || '').replace(/,/g, '\n');
          const urls = raw.split('\n').map(u => u.trim()).filter(u => u.length > 0);
          if (urls.length === 0) {
            Alpine.store('toast').error('Please enter at least one URL.');
            return;
          }
          this.saving = true;

          if (urls.length === 1) {
            // Single URL: create standalone source
            const url = urls[0];
            try {
              let name = this.form.name;
              if (!name) {
                try { const u = new URL(url); name = u.hostname + u.pathname; } catch { name = url; }
              }
              const source = await API.createSource({
                bot_profile_id: this.form.bot_profile_id,
                name,
                source_type: 'url',
                config: { url },
              });
              await API.triggerIngest(source.id);
              Alpine.store('toast').success('Source created & ingestion started');
              this.showCreate = false;
              this.form = { bot_profile_id: '', name: '', source_type: 'text', content: '', config: {} };
              await this.load();
            } catch (e) { Alpine.store('toast').error(e.message); }
          } else {
            // Multiple URLs: batch create parent + children
            try {
              const parentName = this.form.name || `URL Collection (${urls.length} pages)`;
              const children = urls.map(url => {
                let childName;
                try { const u = new URL(url); childName = u.hostname + u.pathname; } catch { childName = url; }
                return { name: childName, source_type: 'url', config: { url } };
              });
              const result = await API.createBatchSource({
                bot_profile_id: this.form.bot_profile_id,
                name: parentName,
                source_type: 'url',
                children,
              });
              await API.triggerIngestChildren(result.parent.id);
              Alpine.store('toast').success(`${urls.length} sources created & ingestion started`);
              this.showCreate = false;
              this.form = { bot_profile_id: '', name: '', source_type: 'text', content: '', config: {} };
              await this.load();
            } catch (e) { Alpine.store('toast').error(e.message); }
          }
          this.saving = false;
        },

        async uploadSource() {
          if (this.uploadFiles.length === 0) {
            Alpine.store('toast').error('Please select at least one file.');
            return;
          }
          if (!this.form.bot_profile_id) {
            Alpine.store('toast').error('Please select a bot profile.');
            return;
          }
          this.uploading = true;
          this.uploadProgress = 0;

          let parentId = null;
          // For 2+ files, create a parent source to group them
          if (this.uploadFiles.length > 1) {
            try {
              const parentName = this.form.name || `File Upload (${this.uploadFiles.length} files)`;
              const parent = await API.createSource({
                bot_profile_id: this.form.bot_profile_id,
                name: parentName,
                source_type: 'upload',
              });
              parentId = parent.id;
            } catch (e) {
              Alpine.store('toast').error(`Failed to create parent: ${e.message}`);
              this.uploading = false;
              return;
            }
          }

          let succeeded = 0;
          let failed = 0;
          for (const file of this.uploadFiles) {
            this.uploadStatus = `Uploading ${file.name}...`;
            try {
              const fd = new FormData();
              fd.append('file', file);
              fd.append('bot_profile_id', this.form.bot_profile_id);
              if (parentId) fd.append('parent_id', parentId);
              await API.uploadSource(fd);
              succeeded++;
            } catch (e) {
              failed++;
              Alpine.store('toast').error(`${file.name}: ${e.message}`);
            }
            this.uploadProgress++;
          }
          this.uploading = false;
          this.uploadStatus = '';
          if (succeeded > 0) {
            const msg = succeeded === 1 ? 'File uploaded & ingestion started' : `${succeeded} files uploaded & ingestion started`;
            Alpine.store('toast').success(failed > 0 ? `${msg} (${failed} failed)` : msg);
            this.showCreate = false;
            this.uploadFiles = [];
            this.form = { bot_profile_id: '', name: '', source_type: 'text', content: '', config: {} };
            await this.load();
          }
        },

        async ingest(src) {
          try {
            await API.triggerIngest(src.id);
            Alpine.store('toast').success('Ingestion started');
            const poll = setInterval(async () => {
              try {
                await this.load();
                const updated = this.sources.find(s => s.id === src.id);
                if (updated && updated.status !== 'processing') clearInterval(poll);
              } catch { clearInterval(poll); }
            }, 3000);
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        async ingestChildren(src) {
          try {
            const result = await API.triggerIngestChildren(src.id);
            Alpine.store('toast').success(`Ingestion started for ${result.enqueued} sources`);
            const poll = setInterval(async () => {
              try {
                await this.load();
                const updated = this.sources.find(s => s.id === src.id);
                if (updated && updated.status !== 'processing') clearInterval(poll);
              } catch { clearInterval(poll); }
            }, 3000);
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        async confirmDelete(src) {
          const msg = src.children_count > 0
            ? `Delete "${src.name}" and its ${src.children_count} child sources?`
            : `Delete "${src.name}"?`;
          if (!confirm(msg)) return;
          try {
            await API.deleteSource(src.id);
            Alpine.store('toast').success('Source deleted');
            delete this.childrenMap[src.id];
            delete this.expandedParents[src.id];
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        async confirmDeleteChild(child) {
          if (!confirm(`Delete "${child.name}"?`)) return;
          try {
            await API.deleteSource(child.id);
            Alpine.store('toast').success('Source deleted');
            // Refresh parent's children
            const parentId = child._parentId;
            if (parentId && this.expandedParents[parentId]) {
              this.childrenMap[parentId] = await API.listSourceChildren(parentId);
            }
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }

    function chatsPage() {
      return {
        chats: [],
        loading: false,
        selectedChat: null,
        messages: [],

        async load() {
          this.loading = true;
          try { this.chats = await API.listChats(); } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        async viewChat(c) {
          this.selectedChat = c;
          try { this.messages = await API.getChatMessages(c.id); } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }

    function tokensPage() {
      return {
        tokens: [],
        loading: false,
        showCreate: false,
        newToken: null,
        form: { name: '' },

        async load() {
          this.loading = true;
          try { this.tokens = await API.listApiTokens(); } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        async createToken() {
          try {
            const data = await API.createApiToken(this.form);
            this.newToken = data.raw_token;
            this.showCreate = false;
            this.form = { name: '' };
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        async revoke(t) {
          if (!confirm(`Revoke token "${t.name}"?`)) return;
          try {
            await API.revokeApiToken(t.id);
            Alpine.store('toast').success('Token revoked');
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }

    function usersPage() {
      return {
        users: [],
        loading: false,
        showCreate: false,
        form: { email: '', password: '', display_name: '', role: 'member' },

        async load() {
          this.loading = true;
          try { this.users = await API.listUsers(); } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        async createUser() {
          try {
            await API.createUser(this.form);
            Alpine.store('toast').success('User created');
            this.showCreate = false;
            this.form = { email: '', password: '', display_name: '', role: 'member' };
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        async deactivate(u) {
          if (!confirm(`Deactivate ${u.email}?`)) return;
          try {
            await API.deleteUser(u.id);
            Alpine.store('toast').success('User deactivated');
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }

    function usagePage() {
      // Pricing fetched from GET /v1/stats/pricing — single source of truth on the backend.
      let _pricingMap = {};
      let _defaultPricing = [1.00, 3.00];

      return {
        usageData: [],
        modelData: [],
        botData: [],
        costEstimate: null,
        loading: false,
        dailyChartInstance: null,
        modelChartInstance: null,
        selectedDays: '30',
        activeTab: 'model',
        tabs: [
          { id: 'model', label: 'By Model' },
          { id: 'bot', label: 'By Bot' },
          { id: 'daily', label: 'Daily Breakdown' },
        ],

        get dateRangeLabel() {
          const labels = { '7': 'Last 7 days', '30': 'Last 30 days', '90': 'Last 90 days' };
          return labels[this.selectedDays] || 'All time';
        },

        get totalRequests() {
          if (!this.costEstimate) return 0;
          return this.costEstimate.by_model.reduce((s, m) => s + m.request_count, 0);
        },

        formatUsd(val) {
          if (val == null) return '$0.00';
          if (val < 0.01 && val > 0) return '<$0.01';
          return '$' + val.toFixed(2);
        },

        calcRowCost(row) {
          const entry = _pricingMap[row.model];
          const pRate = entry ? entry.prompt_cost_per_1m : _defaultPricing[0];
          const cRate = entry ? entry.completion_cost_per_1m : _defaultPricing[1];
          return (row.prompt_tokens * pRate + row.completion_tokens * cRate) / 1_000_000;
        },

        async load() {
          this.loading = true;
          try {
            const d = this.selectedDays ? parseInt(this.selectedDays) : null;
            const [usage, models, bots, estimate, pricing] = await Promise.all([
              API.getUsage(d),
              API.getUsageByModel(d),
              API.getUsageByBot(d),
              API.getCostEstimate(d || 30),
              API.getPricing(),
            ]);
            _pricingMap = pricing.models;
            _defaultPricing = [pricing.default.prompt_cost_per_1m, pricing.default.completion_cost_per_1m];
            this.usageData = usage;
            this.modelData = models;
            this.botData = bots;
            this.costEstimate = estimate;
            this.$nextTick(() => this.renderCharts());
          } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        renderCharts() {
          // Daily token chart
          const dates = [...new Set(this.usageData.map(r => r.date))].sort();
          const dailyTotals = dates.map(d =>
            this.usageData.filter(r => r.date === d).reduce((s, r) => s + r.total_tokens, 0)
          );

          if (this.dailyChartInstance) this.dailyChartInstance.destroy();
          const dailyCtx = this.$refs.dailyChart?.getContext('2d');
          if (dailyCtx) {
            this.dailyChartInstance = new Chart(dailyCtx, {
              type: 'bar',
              data: {
                labels: dates,
                datasets: [{
                  label: 'Total Tokens',
                  data: dailyTotals,
                  backgroundColor: 'rgba(139, 92, 246, 0.5)',
                  borderColor: 'rgba(139, 92, 246, 0.8)',
                  borderWidth: 1,
                  borderRadius: 6,
                }],
              },
              options: { responsive: true, plugins: { legend: { display: false } } },
            });
          }

          // Cost by model doughnut
          const colors = ['#8b5cf6', '#06b6d4', '#f59e0b', '#f43f5e', '#10b981', '#818cf8'];
          const modelLabels = this.modelData.map(m => m.model);
          const modelCosts = this.modelData.map(m => m.cost_usd);

          if (this.modelChartInstance) this.modelChartInstance.destroy();
          const modelCtx = this.$refs.modelChart?.getContext('2d');
          if (modelCtx) {
            this.modelChartInstance = new Chart(modelCtx, {
              type: 'doughnut',
              data: {
                labels: modelLabels,
                datasets: [{
                  data: modelCosts,
                  backgroundColor: colors.slice(0, modelLabels.length),
                  borderColor: 'rgba(255, 255, 255, 0.05)',
                  borderWidth: 2,
                }],
              },
              options: {
                responsive: true,
                plugins: {
                  tooltip: {
                    callbacks: {
                      label: (ctx) => `${ctx.label}: $${ctx.parsed.toFixed(4)}`,
                    },
                  },
                },
              },
            });
          }
        },
      };
    }

    function settingsPage() {
      return {
        health: null,

        async load() {
          await this.checkHealth();
        },

        async checkHealth() {
          try { this.health = await API.getSystemHealth(); } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }
  </script>
</body>
</html>
