<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniRAG Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="/dashboard/css/app.css">
  <script src="/dashboard/js/api.js"></script>
  <script src="/dashboard/js/app.js"></script>
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased" x-data="dashboard()" x-cloak>

  <!-- ═══ Toast ═══════════════════════════════════════════════ -->
  <div x-show="$store.toast.visible"
       x-transition
       :class="{
         'toast-success': $store.toast.type === 'success',
         'toast-error': $store.toast.type === 'error',
         'toast-info': $store.toast.type === 'info',
       }"
       class="toast" x-text="$store.toast.message"></div>

  <!-- ═══ Login Page ═════════════════════════════════════════ -->
  <template x-if="!$store.auth.isLoggedIn">
    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4">
      <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-indigo-100 mb-4">
            <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-900">MiniRAG</h1>
          <p class="text-sm text-gray-500 mt-1">Sign in to your dashboard</p>
        </div>
        <form @submit.prevent="doLogin" class="space-y-4">
          <div>
            <label class="form-label">Email</label>
            <input type="email" x-model="loginForm.email" class="form-input" placeholder="admin@acme.com" required>
          </div>
          <div>
            <label class="form-label">Password</label>
            <input type="password" x-model="loginForm.password" class="form-input" placeholder="********" required>
          </div>
          <div x-show="loginError" class="text-sm text-red-600" x-text="loginError"></div>
          <button type="submit" class="btn-primary w-full" :disabled="loginLoading">
            <span x-show="!loginLoading">Sign In</span>
            <span x-show="loginLoading" class="flex items-center justify-center gap-2">
              <span class="spinner"></span> Signing in...
            </span>
          </button>
        </form>
      </div>
    </div>
  </template>

  <!-- ═══ Authenticated Layout ═══════════════════════════════ -->
  <template x-if="$store.auth.isLoggedIn">
    <div class="flex">
      <!-- Sidebar -->
      <aside class="sidebar bg-gray-900 text-gray-300 flex flex-col fixed top-0 left-0 h-screen"
             :class="{ 'open': sidebarOpen }">
        <div class="p-5 border-b border-gray-800">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-lg bg-indigo-600 flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
              </svg>
            </div>
            <div>
              <div class="font-bold text-white text-sm">MiniRAG</div>
              <div class="text-xs text-gray-500" x-text="$store.auth.tenant?.name"></div>
            </div>
          </div>
        </div>

        <nav class="flex-1 py-4 space-y-1 px-3 overflow-y-auto">
          <template x-for="item in navItems" :key="item.page">
            <button @click="page = item.page; sidebarOpen = false"
                    :class="page === item.page ? 'bg-gray-800 text-white' : 'hover:bg-gray-800/50'"
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm transition-colors">
              <span x-html="item.icon" class="w-5 h-5 opacity-70"></span>
              <span x-text="item.label"></span>
            </button>
          </template>
        </nav>

        <div class="p-4 border-t border-gray-800">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-xs font-bold"
                 x-text="($store.auth.user?.email || '?')[0].toUpperCase()"></div>
            <div class="flex-1 min-w-0">
              <div class="text-sm text-white truncate" x-text="$store.auth.user?.display_name || $store.auth.user?.email"></div>
              <div class="text-xs text-gray-500" x-text="$store.auth.user?.role"></div>
            </div>
          </div>
          <button @click="$store.auth.logout(); page = 'overview'" class="btn-secondary w-full btn-sm">
            Sign Out
          </button>
        </div>
      </aside>

      <!-- Mobile hamburger -->
      <button @click="sidebarOpen = !sidebarOpen"
              class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-gray-900 text-white rounded-lg">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>

      <!-- Main content area -->
      <main class="main-content p-6 lg:p-8 w-full">

        <!-- ── Overview ───────────────────────────────────── -->
        <div x-show="page === 'overview'" x-init="loadOverview()">
          <h2 class="text-2xl font-bold mb-6">Overview</h2>

          <!-- Health cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8" x-show="health">
            <template x-for="[key, val] in Object.entries(health?.postgres ? {postgres: health.postgres, qdrant: health.qdrant, redis: health.redis} : {})" :key="key">
              <div class="stat-card bg-white rounded-xl p-4 shadow-sm border">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-medium text-gray-500 capitalize" x-text="key"></span>
                  <span :class="val.status === 'ok' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                        class="px-2 py-0.5 rounded-full text-xs font-medium" x-text="val.status"></span>
                </div>
              </div>
            </template>
          </div>

          <!-- Summary stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" x-show="stats">
            <div class="stat-card bg-white rounded-xl p-5 shadow-sm border">
              <div class="text-sm text-gray-500">Bot Profiles</div>
              <div class="text-2xl font-bold mt-1" x-text="stats?.bot_profiles ?? '—'"></div>
            </div>
            <div class="stat-card bg-white rounded-xl p-5 shadow-sm border">
              <div class="text-sm text-gray-500">Sources</div>
              <div class="text-2xl font-bold mt-1" x-text="stats?.sources ?? '—'"></div>
            </div>
            <div class="stat-card bg-white rounded-xl p-5 shadow-sm border">
              <div class="text-sm text-gray-500">Chats</div>
              <div class="text-2xl font-bold mt-1" x-text="stats?.chats ?? '—'"></div>
            </div>
            <div class="stat-card bg-white rounded-xl p-5 shadow-sm border">
              <div class="text-sm text-gray-500">Total Tokens</div>
              <div class="text-2xl font-bold mt-1" x-text="(stats?.total_tokens ?? 0).toLocaleString()"></div>
            </div>
          </div>

          <!-- Quick actions -->
          <h3 class="text-lg font-semibold mb-3">Quick Actions</h3>
          <div class="flex flex-wrap gap-3">
            <button @click="page = 'bots'" class="btn-primary">Create Bot Profile</button>
            <button @click="page = 'sources'" class="btn-secondary">Add Source</button>
            <button @click="page = 'tokens'" class="btn-secondary">Generate API Token</button>
          </div>
        </div>

        <!-- ── Bot Profiles ───────────────────────────────── -->
        <div x-show="page === 'bots'" x-data="botsPage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">Bot Profiles</h2>
            <button @click="showCreate = true" class="btn-primary">+ New Bot</button>
          </div>

          <!-- Bot cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="bot in bots" :key="bot.id">
              <div class="bg-white rounded-xl p-5 shadow-sm border hover:shadow-md transition-shadow">
                <div class="flex items-start justify-between mb-3">
                  <div>
                    <h3 class="font-semibold" x-text="bot.name"></h3>
                    <p class="text-xs text-gray-500 mt-0.5" x-text="bot.model"></p>
                  </div>
                  <span :class="bot.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'"
                        class="px-2 py-0.5 rounded-full text-xs" x-text="bot.is_active ? 'Active' : 'Inactive'"></span>
                </div>
                <p class="text-sm text-gray-600 mb-3 line-clamp-2" x-text="bot.description || 'No description'"></p>
                <div class="text-xs text-gray-400 mb-3" x-text="'Temp: ' + bot.temperature + ' | Max tokens: ' + (bot.max_tokens || 'default')"></div>
                <div class="flex gap-2">
                  <button @click="editBot(bot)" class="btn-secondary btn-sm">Edit</button>
                  <button @click="tryBot(bot)" class="btn-success btn-sm">Try It</button>
                  <button @click="confirmDeleteBot(bot)" class="btn-danger btn-sm">Delete</button>
                </div>
              </div>
            </template>
          </div>

          <div x-show="bots.length === 0 && !loading" class="empty-state">
            <p>No bot profiles yet. Create your first one!</p>
          </div>

          <!-- Create/Edit Modal -->
          <div x-show="showCreate || editingBot" class="modal-backdrop" @click.self="closeForm()">
            <div class="modal-content p-6">
              <h3 class="text-lg font-bold mb-4" x-text="editingBot ? 'Edit Bot Profile' : 'New Bot Profile'"></h3>
              <form @submit.prevent="saveBot()" class="space-y-4">
                <div>
                  <label class="form-label">Name</label>
                  <input x-model="form.name" class="form-input" required>
                </div>
                <div>
                  <label class="form-label">Description</label>
                  <input x-model="form.description" class="form-input">
                </div>
                <div>
                  <label class="form-label">Model</label>
                  <select x-model="form.model" class="form-input">
                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="claude-sonnet-4-5-20250929">claude-sonnet-4-5</option>
                    <option value="claude-haiku-4-5-20251001">claude-haiku-4-5</option>
                    <option value="gemini/gemini-2.0-flash">gemini-2.0-flash</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">System Prompt</label>
                  <textarea x-model="form.system_prompt" class="form-input" rows="4" placeholder="You are a helpful assistant..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="form-label">Temperature: <span x-text="form.temperature"></span></label>
                    <input type="range" x-model.number="form.temperature" min="0" max="2" step="0.1" class="w-full">
                  </div>
                  <div>
                    <label class="form-label">Max Tokens</label>
                    <input type="number" x-model.number="form.max_tokens" class="form-input" placeholder="4096">
                  </div>
                </div>
                <div>
                  <label class="form-label">API Key (optional, encrypted at rest)</label>
                  <input x-model="form.credentials.api_key" class="form-input" type="password" placeholder="sk-...">
                </div>
                <div class="flex justify-end gap-2 pt-2">
                  <button type="button" @click="closeForm()" class="btn-secondary">Cancel</button>
                  <button type="submit" class="btn-primary" :disabled="saving">
                    <span x-show="!saving" x-text="editingBot ? 'Update' : 'Create'"></span>
                    <span x-show="saving" class="spinner"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Try It chat panel -->
          <div x-show="tryingBot" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4"
               @click.self="tryingBot = null">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl">
              <div class="flex items-center justify-between p-4 border-b">
                <h3 class="font-bold" x-text="'Chat with ' + (tryingBot?.name || '')"></h3>
                <button @click="tryingBot = null; tryChatId = null; tryMessages = []" class="text-gray-400 hover:text-gray-600">&times;</button>
              </div>
              <div class="chat-inline border-0">
                <div class="chat-messages" x-ref="tryChatMessages">
                  <template x-for="msg in tryMessages" :key="msg.id || msg.content">
                    <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                      <div :class="msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'"
                           class="max-w-[80%] px-4 py-2 rounded-2xl text-sm whitespace-pre-wrap" x-text="msg.content"></div>
                    </div>
                  </template>
                  <div x-show="trySending" class="flex justify-start">
                    <div class="bg-gray-100 px-4 py-2 rounded-2xl"><span class="spinner"></span></div>
                  </div>
                </div>
                <div class="chat-input-bar">
                  <input x-model="tryInput" @keydown.enter.prevent="sendTryMessage()"
                         class="form-input flex-1" placeholder="Type a message..." :disabled="trySending">
                  <button @click="sendTryMessage()" class="btn-primary btn-sm" :disabled="trySending || !tryInput.trim()">Send</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ── Sources ────────────────────────────────────── -->
        <div x-show="page === 'sources'" x-data="sourcesPage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">Sources</h2>
            <button @click="showCreate = true" class="btn-primary">+ New Source</button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <table class="data-table">
              <thead><tr>
                <th>Name</th><th>Type</th><th>Status</th><th>Chunks</th><th>Created</th><th></th>
              </tr></thead>
              <tbody>
                <template x-for="src in sources" :key="src.id">
                  <tr>
                    <td class="font-medium" x-text="src.name"></td>
                    <td><span class="badge bg-gray-100 text-gray-700" x-text="src.source_type"></span></td>
                    <td><span :class="'badge badge-' + src.status" x-text="src.status"></span></td>
                    <td x-text="src.chunk_count"></td>
                    <td class="text-gray-500 text-xs" x-text="formatDate(src.created_at)"></td>
                    <td class="text-right space-x-1">
                      <button @click="ingest(src)" class="btn-success btn-sm"
                              :disabled="src.status === 'processing'">Ingest</button>
                      <button @click="confirmDelete(src)" class="btn-danger btn-sm">Delete</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="sources.length === 0 && !loading" class="empty-state">
              <p>No sources yet.</p>
            </div>
          </div>

          <!-- Create Source Modal -->
          <div x-show="showCreate" class="modal-backdrop" @click.self="showCreate = false">
            <div class="modal-content p-6">
              <h3 class="text-lg font-bold mb-4">New Source</h3>
              <form @submit.prevent="createSource()" class="space-y-4">
                <div>
                  <label class="form-label">Bot Profile</label>
                  <select x-model="form.bot_profile_id" class="form-input" required>
                    <option value="">Select a bot...</option>
                    <template x-for="bp in botProfiles" :key="bp.id">
                      <option :value="bp.id" x-text="bp.name"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label class="form-label">Name</label>
                  <input x-model="form.name" class="form-input" required>
                </div>
                <div>
                  <label class="form-label">Type</label>
                  <select x-model="form.source_type" class="form-input">
                    <option value="text">Text</option>
                    <option value="url">URL</option>
                    <option value="upload">Upload</option>
                  </select>
                </div>
                <div x-show="form.source_type === 'text'">
                  <label class="form-label">Content</label>
                  <textarea x-model="form.content" class="form-input" rows="6" placeholder="Paste your knowledge base text..."></textarea>
                </div>
                <div x-show="form.source_type === 'url'">
                  <label class="form-label">URL</label>
                  <input x-model="form.config.url" class="form-input" placeholder="https://...">
                </div>
                <div class="flex justify-end gap-2">
                  <button type="button" @click="showCreate = false" class="btn-secondary">Cancel</button>
                  <button type="submit" class="btn-primary" :disabled="saving">Create</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- ── Chat History ───────────────────────────────── -->
        <div x-show="page === 'chats'" x-data="chatsPage()" x-init="load()">
          <h2 class="text-2xl font-bold mb-6">Chat History</h2>

          <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <table class="data-table">
              <thead><tr>
                <th>Title</th><th>Messages</th><th>Tokens</th><th>Created</th><th></th>
              </tr></thead>
              <tbody>
                <template x-for="c in chats" :key="c.id">
                  <tr>
                    <td class="font-medium" x-text="truncate(c.title, 50)"></td>
                    <td x-text="c.message_count"></td>
                    <td x-text="(c.total_prompt_tokens + c.total_completion_tokens).toLocaleString()"></td>
                    <td class="text-gray-500 text-xs" x-text="formatDate(c.created_at)"></td>
                    <td class="text-right">
                      <button @click="viewChat(c)" class="btn-secondary btn-sm">View</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="chats.length === 0 && !loading" class="empty-state"><p>No chats yet.</p></div>
          </div>

          <!-- Chat detail modal -->
          <div x-show="selectedChat" class="modal-backdrop" @click.self="selectedChat = null; messages = []">
            <div class="modal-content" style="max-width:600px;">
              <div class="p-4 border-b flex items-center justify-between">
                <h3 class="font-bold" x-text="selectedChat?.title"></h3>
                <button @click="selectedChat = null; messages = []" class="text-gray-400 hover:text-gray-600">&times;</button>
              </div>
              <div class="p-4 space-y-3 max-h-96 overflow-y-auto">
                <template x-for="m in messages" :key="m.id">
                  <div :class="m.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                    <div :class="m.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'"
                         class="max-w-[80%] px-4 py-2 rounded-2xl text-sm whitespace-pre-wrap" x-text="m.content"></div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- ── API Tokens ─────────────────────────────────── -->
        <div x-show="page === 'tokens'" x-data="tokensPage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">API Tokens</h2>
            <button @click="showCreate = true" class="btn-primary">+ New Token</button>
          </div>

          <!-- Newly created token banner -->
          <div x-show="newToken" class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
            <p class="text-sm text-green-800 font-medium mb-2">Token created! Copy it now — it won't be shown again.</p>
            <div class="flex items-center gap-2">
              <code class="bg-white border px-3 py-1.5 rounded text-sm flex-1 overflow-x-auto" x-text="newToken"></code>
              <button @click="copyToClipboard(newToken)" class="btn-primary btn-sm">Copy</button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <table class="data-table">
              <thead><tr>
                <th>Name</th><th>Prefix</th><th>Active</th><th>Last Used</th><th></th>
              </tr></thead>
              <tbody>
                <template x-for="t in tokens" :key="t.id">
                  <tr>
                    <td class="font-medium" x-text="t.name"></td>
                    <td><code class="text-xs bg-gray-100 px-1.5 py-0.5 rounded" x-text="t.token_prefix + '...'"></code></td>
                    <td><span :class="t.is_active ? 'badge-ready' : 'badge-error'" class="badge" x-text="t.is_active ? 'Active' : 'Revoked'"></span></td>
                    <td class="text-xs text-gray-500" x-text="formatDate(t.last_used_at)"></td>
                    <td class="text-right">
                      <button x-show="t.is_active" @click="revoke(t)" class="btn-danger btn-sm">Revoke</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="tokens.length === 0 && !loading" class="empty-state"><p>No API tokens.</p></div>
          </div>

          <!-- Create Token Modal -->
          <div x-show="showCreate" class="modal-backdrop" @click.self="showCreate = false">
            <div class="modal-content p-6">
              <h3 class="text-lg font-bold mb-4">New API Token</h3>
              <form @submit.prevent="createToken()" class="space-y-4">
                <div>
                  <label class="form-label">Name</label>
                  <input x-model="form.name" class="form-input" required placeholder="e.g. production-widget">
                </div>
                <div class="flex justify-end gap-2">
                  <button type="button" @click="showCreate = false" class="btn-secondary">Cancel</button>
                  <button type="submit" class="btn-primary">Create</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- ── Users ──────────────────────────────────────── -->
        <div x-show="page === 'users'" x-data="usersPage()" x-init="load()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold">Users</h2>
            <button x-show="$store.auth.isAdmin" @click="showCreate = true" class="btn-primary">+ New User</button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <table class="data-table">
              <thead><tr>
                <th>Email</th><th>Name</th><th>Role</th><th>Status</th><th></th>
              </tr></thead>
              <tbody>
                <template x-for="u in users" :key="u.id">
                  <tr>
                    <td class="font-medium" x-text="u.email"></td>
                    <td x-text="u.display_name || '—'"></td>
                    <td><span :class="'badge badge-' + u.role" x-text="u.role"></span></td>
                    <td><span :class="u.is_active ? 'badge-ready' : 'badge-error'" class="badge" x-text="u.is_active ? 'Active' : 'Disabled'"></span></td>
                    <td class="text-right">
                      <button x-show="$store.auth.isAdmin && u.is_active && u.id !== $store.auth.user.id"
                              @click="deactivate(u)" class="btn-danger btn-sm">Deactivate</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="users.length === 0 && !loading" class="empty-state"><p>No users found.</p></div>
          </div>

          <!-- Create User Modal -->
          <div x-show="showCreate" class="modal-backdrop" @click.self="showCreate = false">
            <div class="modal-content p-6">
              <h3 class="text-lg font-bold mb-4">New User</h3>
              <form @submit.prevent="createUser()" class="space-y-4">
                <div>
                  <label class="form-label">Email</label>
                  <input type="email" x-model="form.email" class="form-input" required>
                </div>
                <div>
                  <label class="form-label">Password</label>
                  <input type="password" x-model="form.password" class="form-input" required minlength="8">
                </div>
                <div>
                  <label class="form-label">Display Name</label>
                  <input x-model="form.display_name" class="form-input">
                </div>
                <div>
                  <label class="form-label">Role</label>
                  <select x-model="form.role" class="form-input">
                    <option value="member">Member</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
                <div class="flex justify-end gap-2">
                  <button type="button" @click="showCreate = false" class="btn-secondary">Cancel</button>
                  <button type="submit" class="btn-primary">Create</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- ── Usage ──────────────────────────────────────── -->
        <div x-show="page === 'usage'" x-data="usagePage()" x-init="load()">
          <h2 class="text-2xl font-bold mb-6">Usage & Analytics</h2>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl p-5 shadow-sm border">
              <h3 class="font-semibold mb-3">Token Usage by Day</h3>
              <canvas x-ref="dailyChart" height="200"></canvas>
            </div>
            <div class="bg-white rounded-xl p-5 shadow-sm border">
              <h3 class="font-semibold mb-3">Usage by Model</h3>
              <canvas x-ref="modelChart" height="200"></canvas>
            </div>
          </div>

          <!-- Raw data table -->
          <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <table class="data-table">
              <thead><tr>
                <th>Date</th><th>Model</th><th>Requests</th><th>Prompt</th><th>Completion</th><th>Total</th>
              </tr></thead>
              <tbody>
                <template x-for="row in usageData" :key="row.date + row.model">
                  <tr>
                    <td x-text="row.date"></td>
                    <td x-text="row.model"></td>
                    <td x-text="row.request_count"></td>
                    <td x-text="row.prompt_tokens.toLocaleString()"></td>
                    <td x-text="row.completion_tokens.toLocaleString()"></td>
                    <td class="font-medium" x-text="row.total_tokens.toLocaleString()"></td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="usageData.length === 0 && !loading" class="empty-state"><p>No usage data yet.</p></div>
          </div>
        </div>

        <!-- ── Settings ───────────────────────────────────── -->
        <div x-show="page === 'settings'" x-data="settingsPage()" x-init="load()">
          <h2 class="text-2xl font-bold mb-6">Settings</h2>

          <div class="space-y-6">
            <!-- Tenant info -->
            <div class="bg-white rounded-xl p-6 shadow-sm border">
              <h3 class="font-semibold mb-4">Tenant Information</h3>
              <dl class="grid grid-cols-2 gap-4 text-sm">
                <div><dt class="text-gray-500">Name</dt><dd class="font-medium" x-text="$store.auth.tenant?.name"></dd></div>
                <div><dt class="text-gray-500">Slug</dt><dd class="font-medium" x-text="$store.auth.tenant?.slug"></dd></div>
                <div><dt class="text-gray-500">Plan</dt><dd class="font-medium" x-text="$store.auth.tenant?.plan"></dd></div>
                <div><dt class="text-gray-500">Status</dt>
                  <dd><span :class="$store.auth.tenant?.is_active ? 'badge-ready' : 'badge-error'" class="badge"
                            x-text="$store.auth.tenant?.is_active ? 'Active' : 'Disabled'"></span></dd>
                </div>
              </dl>
            </div>

            <!-- System health -->
            <div class="bg-white rounded-xl p-6 shadow-sm border">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold">System Health</h3>
                <button @click="checkHealth()" class="btn-secondary btn-sm">Refresh</button>
              </div>
              <div class="space-y-3" x-show="health">
                <template x-for="[svc, info] in Object.entries(health || {})" :key="svc">
                  <div x-show="svc !== 'status'" class="flex items-center justify-between py-2 border-b last:border-0">
                    <span class="capitalize font-medium text-sm" x-text="svc"></span>
                    <div class="flex items-center gap-2">
                      <span :class="info.status === 'ok' ? 'bg-green-500' : 'bg-red-500'" class="w-2.5 h-2.5 rounded-full"></span>
                      <span class="text-sm" x-text="info.status === 'ok' ? 'Connected' : info.detail || 'Error'"></span>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- App info -->
            <div class="bg-white rounded-xl p-6 shadow-sm border">
              <h3 class="font-semibold mb-4">Application</h3>
              <dl class="grid grid-cols-2 gap-4 text-sm">
                <div><dt class="text-gray-500">Version</dt><dd class="font-medium">0.1.0</dd></div>
                <div><dt class="text-gray-500">API Docs</dt><dd><a href="/docs" target="_blank" class="text-indigo-600 hover:underline">/docs</a></dd></div>
              </dl>
            </div>
          </div>
        </div>

      </main>
    </div>
  </template>

  <!-- ═══ Alpine.js Components ═══════════════════════════════ -->
  <script>
    function dashboard() {
      return {
        page: 'overview',
        sidebarOpen: false,
        loginForm: { email: '', password: '' },
        loginError: '',
        loginLoading: false,
        health: null,
        stats: null,

        navItems: [
          { page: 'overview', label: 'Overview', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>' },
          { page: 'bots', label: 'Bot Profiles', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>' },
          { page: 'sources', label: 'Sources', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>' },
          { page: 'chats', label: 'Chat History', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>' },
          { page: 'tokens', label: 'API Tokens', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>' },
          { page: 'users', label: 'Users', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/></svg>' },
          { page: 'usage', label: 'Usage', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>' },
          { page: 'settings', label: 'Settings', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>' },
        ],

        async doLogin() {
          this.loginError = '';
          this.loginLoading = true;
          try {
            await Alpine.store('auth').login(this.loginForm.email, this.loginForm.password);
            this.page = 'overview';
            this.loginForm = { email: '', password: '' };
          } catch (e) {
            this.loginError = e.message;
          } finally {
            this.loginLoading = false;
          }
        },

        async loadOverview() {
          try {
            [this.health, this.stats] = await Promise.all([
              API.getSystemHealth().catch(() => null),
              API.getOverview().catch(() => null),
            ]);
          } catch {}
        },
      };
    }

    function botsPage() {
      return {
        bots: [],
        loading: false,
        showCreate: false,
        editingBot: null,
        saving: false,
        form: { name: '', description: '', model: 'gpt-4o-mini', system_prompt: '', temperature: 0.7, max_tokens: null, credentials: {} },
        tryingBot: null,
        tryChatId: null,
        tryMessages: [],
        tryInput: '',
        trySending: false,

        async load() {
          this.loading = true;
          try { this.bots = await API.listBotProfiles(); } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        editBot(bot) {
          this.editingBot = bot;
          this.form = {
            name: bot.name,
            description: bot.description || '',
            model: bot.model,
            system_prompt: bot.system_prompt || '',
            temperature: bot.temperature,
            max_tokens: bot.max_tokens,
            credentials: {},
          };
        },

        closeForm() {
          this.showCreate = false;
          this.editingBot = null;
          this.form = { name: '', description: '', model: 'gpt-4o-mini', system_prompt: '', temperature: 0.7, max_tokens: null, credentials: {} };
        },

        async saveBot() {
          this.saving = true;
          try {
            const data = { ...this.form };
            if (!data.credentials?.api_key) delete data.credentials;
            if (!data.max_tokens) delete data.max_tokens;

            if (this.editingBot) {
              await API.updateBotProfile(this.editingBot.id, data);
              Alpine.store('toast').success('Bot profile updated');
            } else {
              await API.createBotProfile(data);
              Alpine.store('toast').success('Bot profile created');
            }
            this.closeForm();
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
          this.saving = false;
        },

        async confirmDeleteBot(bot) {
          if (!confirm(`Deactivate "${bot.name}"?`)) return;
          try {
            await API.deleteBotProfile(bot.id);
            Alpine.store('toast').success('Bot profile deactivated');
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        tryBot(bot) {
          this.tryingBot = bot;
          this.tryChatId = null;
          this.tryMessages = [];
          this.tryInput = '';
        },

        async sendTryMessage() {
          const msg = this.tryInput.trim();
          if (!msg || this.trySending) return;
          this.tryInput = '';
          this.tryMessages.push({ role: 'user', content: msg });
          this.trySending = true;
          try {
            const resp = await API.sendMessage(this.tryingBot.id, msg, this.tryChatId);
            this.tryChatId = resp.chat_id;
            this.tryMessages.push({ role: 'assistant', content: resp.message.content, id: resp.message.id });
          } catch (e) {
            this.tryMessages.push({ role: 'assistant', content: `Error: ${e.message}` });
          }
          this.trySending = false;
          this.$nextTick(() => {
            const el = this.$refs.tryChatMessages;
            if (el) el.scrollTop = el.scrollHeight;
          });
        },
      };
    }

    function sourcesPage() {
      return {
        sources: [],
        botProfiles: [],
        loading: false,
        showCreate: false,
        saving: false,
        form: { bot_profile_id: '', name: '', source_type: 'text', content: '', config: {} },

        async load() {
          this.loading = true;
          try {
            [this.sources, this.botProfiles] = await Promise.all([
              API.listSources(),
              API.listBotProfiles(),
            ]);
          } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        async createSource() {
          this.saving = true;
          try {
            const data = {
              bot_profile_id: this.form.bot_profile_id,
              name: this.form.name,
              source_type: this.form.source_type,
            };
            if (this.form.source_type === 'text') {
              data.content = this.form.content;
            } else if (this.form.source_type === 'url') {
              data.config = { url: this.form.config.url };
            }
            await API.createSource(data);
            Alpine.store('toast').success('Source created');
            this.showCreate = false;
            this.form = { bot_profile_id: '', name: '', source_type: 'text', content: '', config: {} };
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
          this.saving = false;
        },

        async ingest(src) {
          try {
            await API.triggerIngest(src.id);
            Alpine.store('toast').success('Ingestion started');
            // Poll for status
            const poll = setInterval(async () => {
              try {
                await this.load();
                const updated = this.sources.find(s => s.id === src.id);
                if (updated && updated.status !== 'processing') clearInterval(poll);
              } catch { clearInterval(poll); }
            }, 3000);
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        async confirmDelete(src) {
          if (!confirm(`Delete "${src.name}"?`)) return;
          try {
            await API.deleteSource(src.id);
            Alpine.store('toast').success('Source deleted');
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }

    function chatsPage() {
      return {
        chats: [],
        loading: false,
        selectedChat: null,
        messages: [],

        async load() {
          this.loading = true;
          try { this.chats = await API.listChats(); } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        async viewChat(c) {
          this.selectedChat = c;
          try { this.messages = await API.getChatMessages(c.id); } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }

    function tokensPage() {
      return {
        tokens: [],
        loading: false,
        showCreate: false,
        newToken: null,
        form: { name: '' },

        async load() {
          this.loading = true;
          try { this.tokens = await API.listApiTokens(); } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        async createToken() {
          try {
            const data = await API.createApiToken(this.form);
            this.newToken = data.raw_token;
            this.showCreate = false;
            this.form = { name: '' };
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        async revoke(t) {
          if (!confirm(`Revoke token "${t.name}"?`)) return;
          try {
            await API.revokeApiToken(t.id);
            Alpine.store('toast').success('Token revoked');
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }

    function usersPage() {
      return {
        users: [],
        loading: false,
        showCreate: false,
        form: { email: '', password: '', display_name: '', role: 'member' },

        async load() {
          this.loading = true;
          try { this.users = await API.listUsers(); } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        async createUser() {
          try {
            await API.createUser(this.form);
            Alpine.store('toast').success('User created');
            this.showCreate = false;
            this.form = { email: '', password: '', display_name: '', role: 'member' };
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },

        async deactivate(u) {
          if (!confirm(`Deactivate ${u.email}?`)) return;
          try {
            await API.deleteUser(u.id);
            Alpine.store('toast').success('User deactivated');
            await this.load();
          } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }

    function usagePage() {
      return {
        usageData: [],
        loading: false,
        dailyChartInstance: null,
        modelChartInstance: null,

        async load() {
          this.loading = true;
          try {
            this.usageData = await API.getUsage();
            this.$nextTick(() => this.renderCharts());
          } catch (e) { Alpine.store('toast').error(e.message); }
          this.loading = false;
        },

        renderCharts() {
          // Daily chart
          const dates = [...new Set(this.usageData.map(r => r.date))].sort();
          const dailyTotals = dates.map(d =>
            this.usageData.filter(r => r.date === d).reduce((s, r) => s + r.total_tokens, 0)
          );

          if (this.dailyChartInstance) this.dailyChartInstance.destroy();
          const dailyCtx = this.$refs.dailyChart?.getContext('2d');
          if (dailyCtx) {
            this.dailyChartInstance = new Chart(dailyCtx, {
              type: 'bar',
              data: {
                labels: dates,
                datasets: [{
                  label: 'Total Tokens',
                  data: dailyTotals,
                  backgroundColor: 'rgba(79, 70, 229, 0.6)',
                  borderRadius: 4,
                }],
              },
              options: { responsive: true, plugins: { legend: { display: false } } },
            });
          }

          // Model pie chart
          const models = {};
          this.usageData.forEach(r => {
            models[r.model] = (models[r.model] || 0) + r.total_tokens;
          });
          const modelLabels = Object.keys(models);
          const modelValues = Object.values(models);
          const colors = ['#4f46e5', '#06b6d4', '#f59e0b', '#ef4444', '#10b981', '#8b5cf6'];

          if (this.modelChartInstance) this.modelChartInstance.destroy();
          const modelCtx = this.$refs.modelChart?.getContext('2d');
          if (modelCtx) {
            this.modelChartInstance = new Chart(modelCtx, {
              type: 'doughnut',
              data: {
                labels: modelLabels,
                datasets: [{
                  data: modelValues,
                  backgroundColor: colors.slice(0, modelLabels.length),
                }],
              },
              options: { responsive: true },
            });
          }
        },
      };
    }

    function settingsPage() {
      return {
        health: null,

        async load() {
          await this.checkHealth();
        },

        async checkHealth() {
          try { this.health = await API.getSystemHealth(); } catch (e) { Alpine.store('toast').error(e.message); }
        },
      };
    }
  </script>
</body>
</html>
